void 0===Function.prototype.name&&void 0!==Object.defineProperty&&Object.defineProperty(Function.prototype,"name",{get:function(){var a=/function\s([^(]{1,})\(/.exec(this.toString());return a&&1<a.length?a[1].trim():""}});
(function(){var a=function(){try{var a={},b=Object.defineProperty,c=b(a,a,a)&&b}catch(d){}return c||function(a,b,c){a[b]=c.value}}(),b=Object.prototype.toString,c=function(a){return"function"==typeof a||"[object Function]"==b.call(a)},d=Math.pow(2,53)-1;a(Array,"from",{value:function(b){if(null==b)throw new TypeError("`Array.from` requires an array-like object, not `null` or `undefined`");var g=Object(b),m,t;if(1<arguments.length){m=arguments[1];if(!c(m))throw new TypeError("When provided, the second argument to `Array.from` must be a function");
2<arguments.length&&(t=arguments[2])}var k;k=Number(g.length);k=isNaN(k)?0:0!=k&&isFinite(k)?(0<k?1:-1)*Math.floor(Math.abs(k)):k;k=Math.min(Math.max(k,0),d);for(var l=c(this)?Object(new this(k)):Array(k),h=0,r;h<k;)r=g[h],r=m?"undefined"==typeof t?m(r,h):m.call(t,r,h):r,a(l,h,{value:r,configurable:!0,enumerable:!0,writable:!0}),++h;l.length=k;return l},configurable:!0,writable:!0})})();String.prototype.startsWith||(String.prototype.startsWith=function(a,b){b=b||0;return this.indexOf(a,b)===b});
(function(){var a;try{new a("x")}catch(b){a=function(a,b){b=b||{bubbles:!1,cancelable:!1,detail:void 0};var e=document.createEvent("CustomEvent");e.initCustomEvent(a,b.bubbles,b.cancelable,b.detail);return e},a.prototype=window.Event.prototype,window.CustomEvent=a}})();
(function(a,b){"object"===typeof exports&&"undefined"!==typeof module?module.exports=b():"function"===typeof define&&define.amd?define(b):a.PointerEventsPolyfill=b()})(this,function(){function a(){this.array=[];this.size=0}function b(a,b,c,d){this.addCallback=a.bind(d);this.removeCallback=b.bind(d);this.changedCallback=c.bind(d);v&&(this.observer=new v(this.mutationWatcher.bind(this)))}function c(a){return"body /shadow-deep/ "+d(a)}function d(a){return'[touch-action="'+a+'"]'}function e(a){return"{ -ms-touch-action: "+
a+"; touch-action: "+a+"; touch-action-delay: none; }"}function g(a){if(!f.pointermap.has(a))throw Error("InvalidPointerId");}var m="bubbles cancelable view detail screenX screenY clientX clientY ctrlKey altKey shiftKey metaKey button relatedTarget pageX pageY".split(" "),t=[!1,!1,null,null,0,0,0,0,!1,!1,!1,!1,0,null,0,0],k=function(a,b){b=b||Object.create(null);var c=document.createEvent("Event");c.initEvent(a,b.bubbles||!1,b.cancelable||!1);for(var d=2,e;d<m.length;d++)e=m[d],c[e]=b[e]||t[d];c.buttons=
b.buttons||0;d=0;d=b.pressure?b.pressure:c.buttons?.5:0;c.x=c.clientX;c.y=c.clientY;c.pointerId=b.pointerId||0;c.width=b.width||0;c.height=b.height||0;c.pressure=d;c.tiltX=b.tiltX||0;c.tiltY=b.tiltY||0;c.pointerType=b.pointerType||"";c.hwTimestamp=b.hwTimestamp||0;c.isPrimary=b.isPrimary||!1;return c},l=window.Map&&window.Map.prototype.forEach?Map:a;a.prototype={set:function(a,b){if(void 0===b)return this.delete(a);this.has(a)||this.size++;this.array[a]=b},has:function(a){return void 0!==this.array[a]},
delete:function(a){this.has(a)&&(delete this.array[a],this.size--)},get:function(a){return this.array[a]},clear:function(){this.size=this.array.length=0},forEach:function(a,b){return this.array.forEach(function(c,d){a.call(b,c,d,this)},this)}};var h="bubbles cancelable view detail screenX screenY clientX clientY ctrlKey altKey shiftKey metaKey button relatedTarget buttons pointerId width height pressure tiltX tiltY pointerType hwTimestamp isPrimary type target currentTarget which pageX pageY timeStamp".split(" "),
r=[!1,!1,null,null,0,0,0,0,!1,!1,!1,!1,0,null,0,0,0,0,0,0,0,"",0,!1,"",null,null,0,0,0,0],q={pointerover:1,pointerout:1,pointerenter:1,pointerleave:1},y="undefined"!==typeof SVGElementInstance,n={pointermap:new l,eventMap:Object.create(null),captureInfo:Object.create(null),eventSources:Object.create(null),eventSourceList:[],registerSource:function(a,b){var c=b.events;c&&(c.forEach(function(a){b[a]&&(this.eventMap[a]=b[a].bind(b))},this),this.eventSources[a]=b,this.eventSourceList.push(b))},register:function(a){for(var b=
this.eventSourceList.length,c=0,d;c<b&&(d=this.eventSourceList[c]);c++)d.register.call(d,a)},unregister:function(a){for(var b=this.eventSourceList.length,c=0,d;c<b&&(d=this.eventSourceList[c]);c++)d.unregister.call(d,a)},contains:function(a,b){try{return a.contains(b)}catch(c){return!1}},down:function(a){a.bubbles=!0;this.fireEvent("pointerdown",a)},move:function(a){a.bubbles=!0;this.fireEvent("pointermove",a)},up:function(a){a.bubbles=!0;this.fireEvent("pointerup",a)},enter:function(a){a.bubbles=
!1;this.fireEvent("pointerenter",a)},leave:function(a){a.bubbles=!1;this.fireEvent("pointerleave",a)},over:function(a){a.bubbles=!0;this.fireEvent("pointerover",a)},out:function(a){a.bubbles=!0;this.fireEvent("pointerout",a)},cancel:function(a){a.bubbles=!0;this.fireEvent("pointercancel",a)},leaveOut:function(a){this.out(a);this.contains(a.target,a.relatedTarget)||this.leave(a)},enterOver:function(a){this.over(a);this.contains(a.target,a.relatedTarget)||this.enter(a)},eventHandler:function(a){if(!a._handledByPE){var b=
a.type;(b=this.eventMap&&this.eventMap[b])&&b(a);a._handledByPE=!0}},listen:function(a,b){b.forEach(function(b){this.addEvent(a,b)},this)},unlisten:function(a,b){b.forEach(function(b){this.removeEvent(a,b)},this)},addEvent:function(a,b){a.addEventListener(b,this.boundHandler)},removeEvent:function(a,b){a.removeEventListener(b,this.boundHandler)},makeEvent:function(a,b){this.captureInfo[b.pointerId]&&(b.relatedTarget=null);var c=new k(a,b);b.preventDefault&&(c.preventDefault=b.preventDefault);c._target=
c._target||b.target;return c},fireEvent:function(a,b){var c=this.makeEvent(a,b);return this.dispatchEvent(c)},cloneEvent:function(a){for(var b=Object.create(null),c,d=0;d<h.length;d++)c=h[d],b[c]=a[c]||r[d],y&&("target"===c||"relatedTarget"===c)&&b[c]instanceof SVGElementInstance&&(b[c]=b[c].correspondingUseElement);a.preventDefault&&(b.preventDefault=function(){a.preventDefault()});return b},getTarget:function(a){var b=this.captureInfo[a.pointerId];if(!b)return a._target;if(a._target===b||!(a.type in
q))return b},setCapture:function(a,b){this.captureInfo[a]&&this.releaseCapture(a);this.captureInfo[a]=b;var c=document.createEvent("Event");c.initEvent("gotpointercapture",!0,!1);c.pointerId=a;this.implicitRelease=this.releaseCapture.bind(this,a);document.addEventListener("pointerup",this.implicitRelease);document.addEventListener("pointercancel",this.implicitRelease);c._target=b;this.asyncDispatchEvent(c)},releaseCapture:function(a){var b=this.captureInfo[a];if(b){var c=document.createEvent("Event");
c.initEvent("lostpointercapture",!0,!1);c.pointerId=a;this.captureInfo[a]=void 0;document.removeEventListener("pointerup",this.implicitRelease);document.removeEventListener("pointercancel",this.implicitRelease);c._target=b;this.asyncDispatchEvent(c)}},dispatchEvent:function(a){var b=this.getTarget(a);if(b)return b.dispatchEvent(a)},asyncDispatchEvent:function(a){requestAnimationFrame(this.dispatchEvent.bind(this,a))}};n.boundHandler=n.eventHandler.bind(n);var f=n,p={shadow:function(a){if(a)return a.shadowRoot||
a.webkitShadowRoot},canTarget:function(a){return a&&Boolean(a.elementFromPoint)},targetingShadow:function(a){a=this.shadow(a);if(this.canTarget(a))return a},olderShadow:function(a){var b=a.olderShadowRoot;!b&&(a=a.querySelector("shadow"))&&(b=a.olderShadowRoot);return b},allShadows:function(a){var b=[];for(a=this.shadow(a);a;)b.push(a),a=this.olderShadow(a);return b},searchRoot:function(a,b,c){if(a){var d=a.elementFromPoint(b,c),e;for(e=this.targetingShadow(d);e;){if(a=e.elementFromPoint(b,c))return d=
this.targetingShadow(a),this.searchRoot(d,b,c)||a;e=this.olderShadow(e)}return d}},owner:function(a){for(;a.parentNode;)a=a.parentNode;a.nodeType!==Node.DOCUMENT_NODE&&a.nodeType!==Node.DOCUMENT_FRAGMENT_NODE&&(a=document);return a},findTarget:function(a){var b=a.clientX,c=a.clientY;a=this.owner(a.target);a.elementFromPoint(b,c)||(a=document);return this.searchRoot(a,b,c)}},w=Array.prototype.forEach.call.bind(Array.prototype.forEach),x=Array.prototype.map.call.bind(Array.prototype.map),B=Array.prototype.slice.call.bind(Array.prototype.slice),
A=Array.prototype.filter.call.bind(Array.prototype.filter),v=window.MutationObserver||window.WebKitMutationObserver,F={subtree:!0,childList:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["touch-action"]};b.prototype={watchSubtree:function(a){this.observer&&p.canTarget(a)&&this.observer.observe(a,F)},enableOnSubtree:function(a){this.watchSubtree(a);a===document&&"complete"!==document.readyState?this.installOnLoad():this.installNewSubtree(a)},installNewSubtree:function(a){w(this.findElements(a),
this.addElement,this)},findElements:function(a){return a.querySelectorAll?a.querySelectorAll("[touch-action]"):[]},removeElement:function(a){this.removeCallback(a)},addElement:function(a){this.addCallback(a)},elementChanged:function(a,b){this.changedCallback(a,b)},concatLists:function(a,b){return a.concat(B(b))},installOnLoad:function(){document.addEventListener("readystatechange",function(){"complete"===document.readyState&&this.installNewSubtree(document)}.bind(this))},isElement:function(a){return a.nodeType===
Node.ELEMENT_NODE},flattenMutationTree:function(a){var b=x(a,this.findElements,this);b.push(A(a,this.isElement));return b.reduce(this.concatLists,[])},mutationWatcher:function(a){a.forEach(this.mutationHandler,this)},mutationHandler:function(a){"childList"===a.type?(this.flattenMutationTree(a.addedNodes).forEach(this.addElement,this),this.flattenMutationTree(a.removedNodes).forEach(this.removeElement,this)):"attributes"===a.type&&this.elementChanged(a.target,a.oldValue)}};var E=["none","auto","pan-x",
"pan-y",{rule:"pan-x pan-y",selectors:["pan-x pan-y","pan-y pan-x"]}],u="",O=window.PointerEvent||window.MSPointerEvent,K=!window.ShadowDOMPolyfill&&document.head.createShadowRoot,C=f.pointermap,G=[1,4,2,8,16],D=!1;try{D=1===(new MouseEvent("test",{buttons:1})).buttons}catch(T){}var L={POINTER_ID:1,POINTER_TYPE:"mouse",events:["mousedown","mousemove","mouseup","mouseover","mouseout"],register:function(a){f.listen(a,this.events)},unregister:function(a){f.unlisten(a,this.events)},lastTouches:[],isEventSimulatedFromTouch:function(a){var b=
this.lastTouches,c=a.clientX;a=a.clientY;for(var d=0,e=b.length,u;d<e&&(u=b[d]);d++){var f=Math.abs(c-u.x),g=Math.abs(a-u.y);if(25>=f&&25>=g)return!0}},prepareEvent:function(a){var b=f.cloneEvent(a),c=b.preventDefault;b.preventDefault=function(){a.preventDefault();c()};b.pointerId=this.POINTER_ID;b.isPrimary=!0;b.pointerType=this.POINTER_TYPE;return b},prepareButtonsForMove:function(a,b){var c=C.get(this.POINTER_ID);a.buttons=c?c.buttons:0;b.buttons=a.buttons},mousedown:function(a){if(!this.isEventSimulatedFromTouch(a)){var b=
C.get(this.POINTER_ID),c=this.prepareEvent(a);D||(c.buttons=G[c.button],b&&(c.buttons|=b.buttons),a.buttons=c.buttons);C.set(this.POINTER_ID,a);b?f.move(c):f.down(c)}},mousemove:function(a){if(!this.isEventSimulatedFromTouch(a)){var b=this.prepareEvent(a);D||this.prepareButtonsForMove(b,a);f.move(b)}},mouseup:function(a){if(!this.isEventSimulatedFromTouch(a)){var b=C.get(this.POINTER_ID),c=this.prepareEvent(a);if(!D){var d=G[c.button];c.buttons=b?b.buttons&~d:0;a.buttons=c.buttons}C.set(this.POINTER_ID,
a);0===c.buttons||c.buttons===G[c.button]?(this.cleanupMouse(),f.up(c)):f.move(c)}},mouseover:function(a){if(!this.isEventSimulatedFromTouch(a)){var b=this.prepareEvent(a);D||this.prepareButtonsForMove(b,a);f.enterOver(b)}},mouseout:function(a){if(!this.isEventSimulatedFromTouch(a)){var b=this.prepareEvent(a);D||this.prepareButtonsForMove(b,a);f.leaveOut(b)}},cancel:function(a){a=this.prepareEvent(a);f.cancel(a);this.cleanupMouse()},cleanupMouse:function(){C.delete(this.POINTER_ID)}},P=f.captureInfo,
Q=p.findTarget.bind(p),H=p.allShadows.bind(p),z=f.pointermap,M,n={events:["touchstart","touchmove","touchend","touchcancel"],register:function(a){M.enableOnSubtree(a)},unregister:function(a){},elementAdded:function(a){var b=a.getAttribute("touch-action"),c=this.touchActionToScrollType(b);c&&(a._scrollType=c,f.listen(a,this.events),H(a).forEach(function(a){a._scrollType=c;f.listen(a,this.events)},this))},elementRemoved:function(a){a._scrollType=void 0;f.unlisten(a,this.events);H(a).forEach(function(a){a._scrollType=
void 0;f.unlisten(a,this.events)},this)},elementChanged:function(a,b){var c=a.getAttribute("touch-action"),d=this.touchActionToScrollType(c),c=this.touchActionToScrollType(b);d&&c?(a._scrollType=d,H(a).forEach(function(a){a._scrollType=d},this)):c?this.elementRemoved(a):d&&this.elementAdded(a)},scrollTypes:{EMITTER:"none",XSCROLLER:"pan-x",YSCROLLER:"pan-y",SCROLLER:/^(?:pan-x pan-y)|(?:pan-y pan-x)|auto$/},touchActionToScrollType:function(a){var b=this.scrollTypes;if("none"===a)return"none";if(a===
b.XSCROLLER)return"X";if(a===b.YSCROLLER)return"Y";if(b.SCROLLER.exec(a))return"XY"},POINTER_TYPE:"touch",firstTouch:null,isPrimaryTouch:function(a){return this.firstTouch===a.identifier},setPrimaryTouch:function(a){if(0===z.size||1===z.size&&z.has(1))this.firstTouch=a.identifier,this.firstXY={X:a.clientX,Y:a.clientY},this.scrolling=!1,this.cancelResetClickCount()},removePrimaryPointer:function(a){a.isPrimary&&(this.firstXY=this.firstTouch=null,this.resetClickCount())},clickCount:0,resetId:null,resetClickCount:function(){var a=
function(){this.clickCount=0;this.resetId=null}.bind(this);this.resetId=setTimeout(a,200)},cancelResetClickCount:function(){this.resetId&&clearTimeout(this.resetId)},typeToButtons:function(a){var b=0;if("touchstart"===a||"touchmove"===a)b=1;return b},touchToPointer:function(a){var b=this.currentTouchEvent,c=f.cloneEvent(a),d=c.pointerId=a.identifier+2;c.target=P[d]||Q(c);c.bubbles=!0;c.cancelable=!0;c.detail=this.clickCount;c.button=0;c.buttons=this.typeToButtons(b.type);c.width=a.radiusX||a.webkitRadiusX||
0;c.height=a.radiusY||a.webkitRadiusY||0;c.pressure=a.force||a.webkitForce||.5;c.isPrimary=this.isPrimaryTouch(a);c.pointerType=this.POINTER_TYPE;var e=this;c.preventDefault=function(){e.scrolling=!1;e.firstXY=null;b.preventDefault()};return c},processTouches:function(a,b){var c=a.changedTouches;this.currentTouchEvent=a;for(var d=0,e;d<c.length;d++)e=c[d],b.call(this,this.touchToPointer(e))},shouldScroll:function(a){if(this.firstXY){var b;b=a.currentTarget._scrollType;if("none"===b)b=!1;else if("XY"===
b)b=!0;else{a=a.changedTouches[0];var c="Y"===b?"X":"Y";b=Math.abs(a["client"+b]-this.firstXY[b]);a=Math.abs(a["client"+c]-this.firstXY[c]);b=b>=a}this.firstXY=null;return b}},findTouch:function(a,b){for(var c=0,d=a.length,e;c<d&&(e=a[c]);c++)if(e.identifier===b)return!0},vacuumTouches:function(a){var b=a.touches;if(z.size>=b.length){var c=[];z.forEach(function(a,d){1===d||this.findTouch(b,d-2)||c.push(a.out)},this);c.forEach(this.cancelOut,this)}},touchstart:function(a){this.vacuumTouches(a);this.setPrimaryTouch(a.changedTouches[0]);
this.dedupSynthMouse(a);this.scrolling||(this.clickCount++,this.processTouches(a,this.overDown))},overDown:function(a){z.set(a.pointerId,{target:a.target,out:a,outTarget:a.target});f.over(a);f.enter(a);f.down(a)},touchmove:function(a){this.scrolling||(this.shouldScroll(a)?(this.scrolling=!0,this.touchcancel(a)):(a.preventDefault(),this.processTouches(a,this.moveOverOut)))},moveOverOut:function(a){var b=z.get(a.pointerId);if(b){var c=b.out,d=b.outTarget;f.move(a);c&&d!==a.target&&(c.relatedTarget=
a.target,a.relatedTarget=d,c.target=d,a.target?(f.leaveOut(c),f.enterOver(a)):(a.target=d,a.relatedTarget=null,this.cancelOut(a)));b.out=a;b.outTarget=a.target}},touchend:function(a){this.dedupSynthMouse(a);this.processTouches(a,this.upOut)},upOut:function(a){this.scrolling||(f.up(a),f.out(a),f.leave(a));this.cleanUpPointer(a)},touchcancel:function(a){this.processTouches(a,this.cancelOut)},cancelOut:function(a){f.cancel(a);f.out(a);f.leave(a);this.cleanUpPointer(a)},cleanUpPointer:function(a){z.delete(a.pointerId);
this.removePrimaryPointer(a)},dedupSynthMouse:function(a){var b=L.lastTouches;a=a.changedTouches[0];this.isPrimaryTouch(a)&&(a={x:a.clientX,y:a.clientY},b.push(a),b=function(a,b){var c=a.indexOf(b);-1<c&&a.splice(c,1)}.bind(null,b,a),setTimeout(b,2500))}};M=new b(n.elementAdded,n.elementRemoved,n.elementChanged,n);var N=f.pointermap,R=window.MSPointerEvent&&"number"===typeof window.MSPointerEvent.MSPOINTER_TYPE_MOUSE,S={events:"MSPointerDown MSPointerMove MSPointerUp MSPointerOut MSPointerOver MSPointerCancel MSGotPointerCapture MSLostPointerCapture".split(" "),
register:function(a){f.listen(a,this.events)},unregister:function(a){f.unlisten(a,this.events)},POINTER_TYPES:["","unavailable","touch","pen","mouse"],prepareEvent:function(a){var b=a;R&&(b=f.cloneEvent(a),b.pointerType=this.POINTER_TYPES[a.pointerType]);return b},cleanup:function(a){N.delete(a)},MSPointerDown:function(a){N.set(a.pointerId,a);a=this.prepareEvent(a);f.down(a)},MSPointerMove:function(a){a=this.prepareEvent(a);f.move(a)},MSPointerUp:function(a){var b=this.prepareEvent(a);f.up(b);this.cleanup(a.pointerId)},
MSPointerOut:function(a){a=this.prepareEvent(a);f.leaveOut(a)},MSPointerOver:function(a){a=this.prepareEvent(a);f.enterOver(a)},MSPointerCancel:function(a){var b=this.prepareEvent(a);f.cancel(b);this.cleanup(a.pointerId)},MSLostPointerCapture:function(a){a=f.makeEvent("lostpointercapture",a);f.dispatchEvent(a)},MSGotPointerCapture:function(a){a=f.makeEvent("gotpointercapture",a);f.dispatchEvent(a)}},I,J;window.navigator.msPointerEnabled?(I=function(a){g(a);this.msSetPointerCapture(a)},J=function(a){g(a);
this.msReleasePointerCapture(a)}):(I=function(a){g(a);f.setCapture(a,this)},J=function(a){g(a);f.releaseCapture(a,this)});(function(){if(O){E.forEach(function(a){String(a)===a?(u+=d(a)+e(a)+"\n",K&&(u+=c(a)+e(a)+"\n")):(u+=a.selectors.map(d)+e(a.rule)+"\n",K&&(u+=a.selectors.map(c)+e(a.rule)+"\n"))});var a=document.createElement("style");a.textContent=u;document.head.appendChild(a)}})();window.PointerEvent||(window.PointerEvent=k,window.navigator.msPointerEnabled?(Object.defineProperty(window.navigator,
"maxTouchPoints",{value:window.navigator.msMaxTouchPoints,enumerable:!0}),f.registerSource("ms",S)):(f.registerSource("mouse",L),void 0!==window.ontouchstart&&f.registerSource("touch",n)),f.register(document));window.Element&&!Element.prototype.setPointerCapture&&Object.defineProperties(Element.prototype,{setPointerCapture:{value:I},releasePointerCapture:{value:J}});return{dispatcher:f,Installer:b,PointerEvent:k,PointerMap:l,targetFinding:p}});
"function"!=typeof Object.assign&&function(){Object.assign=function(a){if(void 0===a||null===a)throw new TypeError("Cannot convert undefined or null to object");for(var b=Object(a),c=1;c<arguments.length;c++){var d=arguments[c];if(void 0!==d&&null!==d)for(var e in d)d.hasOwnProperty(e)&&(b[e]=d[e])}return b}}();function LangUtils(){}LangUtils.mergeProperty=function(a,b,c){b=b[c];var d=a[c];null!==b&&"undefined"!==typeof b&&("object"===typeof b?d?LangUtils.deepMerge(d,b):"function"===typeof b.clone?a[c]=b.clone():console.warn("mergeProperty ignores "+c):"function"!==typeof d&&(a[c]=b))};LangUtils.deepMerge=function(a,b){if(!b)return a;for(var c in b)b.hasOwnProperty(c)&&LangUtils.mergeProperty(a,b,c);return a};var BrowserFeatures={hasTouch:"ontouchstart"in window||0<navigator.MaxTouchPoints||0<navigator.msMaxTouchPoints};(function(){document.body.className+=BrowserFeatures.hasTouch?"touch":"no-touch"})();(function(a){function b(a,b){return-1!==String(a).indexOf(b)}function c(a,b,c){y!==b&&q!==b&&r!==b||Object.keys(c).forEach(function(b){a[b]=c[b]})}function d(a){var b="keyCode"in a?a.keyCode:"which"in a?a.which:0,c=function(){if(A||"keyLocation"in a){var c=A?a.location:a.keyLocation;if(c&&b in p[c])return p[c][b]}return"keyIdentifier"in a&&a.keyIdentifier in f?f[a.keyIdentifier]:b in n?n[b]:null}();if(!c)return null;var d=function(){var b=w[c.code];return b?a.shiftKey&&"shiftKey"in b?b.shiftKey:b.key:
c.code}();return{code:c.code,key:d,location:c.location,keyCap:c.keyCap}}function e(a,b){a=String(a);if(!B.hasOwnProperty(a))return"Undefined";if(b&&"en-us"!==String(b).toLowerCase())throw Error("Unsupported locale");var c=B[a];return c.keyCap||c.code||"Undefined"}var g="KeyboardEvent"in a;g||(a.KeyboardEvent=function(){throw TypeError("Illegal constructor");});try{a.KeyboardEvent.DOM_KEY_LOCATION_STANDARD=0,a.KeyboardEvent.DOM_KEY_LOCATION_LEFT=1,a.KeyboardEvent.DOM_KEY_LOCATION_RIGHT=2,a.KeyboardEvent.DOM_KEY_LOCATION_NUMPAD=
3}catch(m){}var t=window.KeyboardEvent.DOM_KEY_LOCATION_STANDARD,k=window.KeyboardEvent.DOM_KEY_LOCATION_LEFT,l=window.KeyboardEvent.DOM_KEY_LOCATION_RIGHT,h=window.KeyboardEvent.DOM_KEY_LOCATION_NUMPAD,r=b(navigator.platform,"Win")?"win":b(navigator.platform,"Mac")?"mac":b(navigator.platform,"CrOS")?"cros":b(navigator.platform,"Linux")?"linux":b(navigator.userAgent,"iPad")||b(navigator.platform,"iPod")||b(navigator.platform,"iPhone")?"ios":"",q=b(navigator.userAgent,"Chrome/")?"chrome":b(navigator.vendor,
"Apple")?"safari":b(navigator.userAgent,"MSIE")?"ie":b(navigator.userAgent,"Gecko/")?"moz":b(navigator.userAgent,"Opera/")?"opera":"",y=q+"-"+r,n={3:{code:"Cancel"},6:{code:"Help"},8:{code:"Backspace"},9:{code:"Tab"},12:{code:"Clear"},13:{code:"Enter"},16:{code:"Shift"},17:{code:"Control"},18:{code:"Alt"},19:{code:"Pause"},20:{code:"CapsLock"},21:{code:"KanaMode"},22:{code:"HangulMode"},23:{code:"JunjaMode"},24:{code:"FinalMode"},25:{code:"KanjiMode"},27:{code:"Escape"},28:{code:"Convert"},29:{code:"NonConvert"},
30:{code:"Accept"},31:{code:"ModeChange"},32:{code:"Space"},33:{code:"PageUp"},34:{code:"PageDown"},35:{code:"End"},36:{code:"Home"},37:{code:"ArrowLeft"},38:{code:"ArrowUp"},39:{code:"ArrowRight"},40:{code:"ArrowDown"},41:{code:"Select"},42:{code:"Print"},43:{code:"Execute"},44:{code:"PrintScreen"},45:{code:"Insert"},46:{code:"Delete"},47:{code:"Help"},48:{code:"Digit0",keyCap:"0"},49:{code:"Digit1",keyCap:"1"},50:{code:"Digit2",keyCap:"2"},51:{code:"Digit3",keyCap:"3"},52:{code:"Digit4",keyCap:"4"},
53:{code:"Digit5",keyCap:"5"},54:{code:"Digit6",keyCap:"6"},55:{code:"Digit7",keyCap:"7"},56:{code:"Digit8",keyCap:"8"},57:{code:"Digit9",keyCap:"9"},65:{code:"KeyA",keyCap:"a"},66:{code:"KeyB",keyCap:"b"},67:{code:"KeyC",keyCap:"c"},68:{code:"KeyD",keyCap:"d"},69:{code:"KeyE",keyCap:"e"},70:{code:"KeyF",keyCap:"f"},71:{code:"KeyG",keyCap:"g"},72:{code:"KeyH",keyCap:"h"},73:{code:"KeyI",keyCap:"i"},74:{code:"KeyJ",keyCap:"j"},75:{code:"KeyK",keyCap:"k"},76:{code:"KeyL",keyCap:"l"},77:{code:"KeyM",
keyCap:"m"},78:{code:"KeyN",keyCap:"n"},79:{code:"KeyO",keyCap:"o"},80:{code:"KeyP",keyCap:"p"},81:{code:"KeyQ",keyCap:"q"},82:{code:"KeyR",keyCap:"r"},83:{code:"KeyS",keyCap:"s"},84:{code:"KeyT",keyCap:"t"},85:{code:"KeyU",keyCap:"u"},86:{code:"KeyV",keyCap:"v"},87:{code:"KeyW",keyCap:"w"},88:{code:"KeyX",keyCap:"x"},89:{code:"KeyY",keyCap:"y"},90:{code:"KeyZ",keyCap:"z"},91:{code:"OSLeft",location:k},92:{code:"OSRight",location:l},93:{code:"ContextMenu"},95:{code:"Standby"},96:{code:"Numpad0",keyCap:"0",
location:h},97:{code:"Numpad1",keyCap:"1",location:h},98:{code:"Numpad2",keyCap:"2",location:h},99:{code:"Numpad3",keyCap:"3",location:h},100:{code:"Numpad4",keyCap:"4",location:h},101:{code:"Numpad5",keyCap:"5",location:h},102:{code:"Numpad6",keyCap:"6",location:h},103:{code:"Numpad7",keyCap:"7",location:h},104:{code:"Numpad8",keyCap:"8",location:h},105:{code:"Numpad9",keyCap:"9",location:h},106:{code:"NumpadMultiply",keyCap:"*",location:h},107:{code:"NumpadAdd",keyCap:"+",location:h},108:{code:"NumpadComma",
keyCap:",",location:h},109:{code:"NumpadSubtract",keyCap:"-",location:h},110:{code:"NumpadDecimal",keyCap:".",location:h},111:{code:"NumpadDivide",keyCap:"/",location:h},112:{code:"F1"},113:{code:"F2"},114:{code:"F3"},115:{code:"F4"},116:{code:"F5"},117:{code:"F6"},118:{code:"F7"},119:{code:"F8"},120:{code:"F9"},121:{code:"F10"},122:{code:"F11"},123:{code:"F12"},124:{code:"F13"},125:{code:"F14"},126:{code:"F15"},127:{code:"F16"},128:{code:"F17"},129:{code:"F18"},130:{code:"F19"},131:{code:"F20"},
132:{code:"F21"},133:{code:"F22"},134:{code:"F23"},135:{code:"F24"},144:{code:"NumLock",location:h},145:{code:"ScrollLock"},160:{code:"ShiftLeft",location:k},161:{code:"ShiftRight",location:l},162:{code:"ControlLeft",location:k},163:{code:"ControlRight",location:l},164:{code:"AltLeft",location:k},165:{code:"AltRight",location:l},166:{code:"BrowserBack"},167:{code:"BrowserForward"},168:{code:"BrowserRefresh"},169:{code:"BrowserStop"},170:{code:"BrowserSearch"},171:{code:"BrowserFavorites"},172:{code:"BrowserHome"},
173:{code:"VolumeMute"},174:{code:"VolumeDown"},175:{code:"VolumeUp"},176:{code:"MediaTrackNext"},177:{code:"MediaTrackPrevious"},178:{code:"MediaStop"},179:{code:"MediaPlayPause"},180:{code:"LaunchMail"},181:{code:"MediaSelect"},182:{code:"LaunchApp1"},183:{code:"LaunchApp2"},186:{code:"Semicolon",keyCap:";"},187:{code:"Equal",keyCap:"="},188:{code:"Comma",keyCap:","},189:{code:"Minus",keyCap:"-"},190:{code:"Period",keyCap:"."},191:{code:"Slash",keyCap:"/"},192:{code:"Backquote",keyCap:"`"},219:{code:"BracketLeft",
keyCap:"["},220:{code:"Backslash",keyCap:"\\"},221:{code:"BracketRight",keyCap:"]"},222:{code:"Quote",keyCap:"'"},226:{code:"IntlBackslash",keyCap:"\\"},229:{code:"Process"},246:{code:"Attn"},247:{code:"CrSel"},248:{code:"ExSel"},249:{code:"EraseEof"},250:{code:"Play"},251:{code:"ZoomToggle"},254:{code:"Clear"}};c(n,"moz",{59:{code:"Semicolon",keyCap:";"},61:{code:"Equal",keyCap:"="},107:{code:"Equal",keyCap:"="},109:{code:"Minus",keyCap:"-"},187:{code:"NumpadAdd",keyCap:"+",location:h},189:{code:"NumpadSubtract",
keyCap:"-",location:h}});c(n,"moz-mac",{12:{code:"NumLock",location:h},173:{code:"Minus",keyCap:"-"}});c(n,"moz-win",{173:{code:"Minus",keyCap:"-"}});c(n,"chrome-mac",{93:{code:"OSRight",location:l}});c(n,"safari",{3:{code:"Enter"},25:{code:"Tab"}});c(n,"ios",{10:{code:"Enter",location:t}});c(n,"safari-mac",{91:{code:"OSLeft",location:k},93:{code:"OSRight",location:l},229:{code:"KeyQ",keyCap:"Q"}});var f={};"cros"===r&&(f["U+00A0"]={code:"ShiftLeft",location:k},f["U+00A1"]={code:"ShiftRight",location:l},
f["U+00A2"]={code:"ControlLeft",location:k},f["U+00A3"]={code:"ControlRight",location:l},f["U+00A4"]={code:"AltLeft",location:k},f["U+00A5"]={code:"AltRight",location:l});"chrome-mac"===y&&(f["U+0010"]={code:"ContextMenu"});"safari-mac"===y&&(f["U+0010"]={code:"ContextMenu"});"ios"===r&&(f["U+0010"]={code:"Function"},f["U+001C"]={code:"ArrowLeft"},f["U+001D"]={code:"ArrowRight"},f["U+001E"]={code:"ArrowUp"},f["U+001F"]={code:"ArrowDown"},f["U+0001"]={code:"Home"},f["U+0004"]={code:"End"},f["U+000B"]=
{code:"PageUp"},f["U+000C"]={code:"PageDown"});var p=[];p[k]={16:{code:"ShiftLeft",location:k},17:{code:"ControlLeft",location:k},18:{code:"AltLeft",location:k}};p[l]={16:{code:"ShiftRight",location:l},17:{code:"ControlRight",location:l},18:{code:"AltRight",location:l}};p[h]={13:{code:"NumpadEnter",location:h}};c(p[h],"moz",{109:{code:"NumpadSubtract",location:h},107:{code:"NumpadAdd",location:h}});c(p[k],"moz-mac",{224:{code:"OSLeft",location:k}});c(p[l],"moz-mac",{224:{code:"OSRight",location:l}});
c(p[l],"moz-win",{91:{code:"OSRight",location:l}});c(p[l],"mac",{93:{code:"OSRight",location:l}});c(p[h],"chrome-mac",{12:{code:"NumLock",location:h}});c(p[h],"safari-mac",{12:{code:"NumLock",location:h},187:{code:"NumpadAdd",location:h},189:{code:"NumpadSubtract",location:h},190:{code:"NumpadDecimal",location:h},191:{code:"NumpadDivide",location:h}});var w={ShiftLeft:{key:"Shift"},ShiftRight:{key:"Shift"},ControlLeft:{key:"Control"},ControlRight:{key:"Control"},AltLeft:{key:"Alt"},AltRight:{key:"Alt"},
OSLeft:{key:"OS"},OSRight:{key:"OS"},NumpadEnter:{key:"Enter"},Space:{key:" "},Digit0:{key:"0",shiftKey:")"},Digit1:{key:"1",shiftKey:"!"},Digit2:{key:"2",shiftKey:"@"},Digit3:{key:"3",shiftKey:"#"},Digit4:{key:"4",shiftKey:"$"},Digit5:{key:"5",shiftKey:"%"},Digit6:{key:"6",shiftKey:"^"},Digit7:{key:"7",shiftKey:"&"},Digit8:{key:"8",shiftKey:"*"},Digit9:{key:"9",shiftKey:"("},KeyA:{key:"a",shiftKey:"A"},KeyB:{key:"b",shiftKey:"B"},KeyC:{key:"c",shiftKey:"C"},KeyD:{key:"d",shiftKey:"D"},KeyE:{key:"e",
shiftKey:"E"},KeyF:{key:"f",shiftKey:"F"},KeyG:{key:"g",shiftKey:"G"},KeyH:{key:"h",shiftKey:"H"},KeyI:{key:"i",shiftKey:"I"},KeyJ:{key:"j",shiftKey:"J"},KeyK:{key:"k",shiftKey:"K"},KeyL:{key:"l",shiftKey:"L"},KeyM:{key:"m",shiftKey:"M"},KeyN:{key:"n",shiftKey:"N"},KeyO:{key:"o",shiftKey:"O"},KeyP:{key:"p",shiftKey:"P"},KeyQ:{key:"q",shiftKey:"Q"},KeyR:{key:"r",shiftKey:"R"},KeyS:{key:"s",shiftKey:"S"},KeyT:{key:"t",shiftKey:"T"},KeyU:{key:"u",shiftKey:"U"},KeyV:{key:"v",shiftKey:"V"},KeyW:{key:"w",
shiftKey:"W"},KeyX:{key:"x",shiftKey:"X"},KeyY:{key:"y",shiftKey:"Y"},KeyZ:{key:"z",shiftKey:"Z"},Numpad0:{key:"0"},Numpad1:{key:"1"},Numpad2:{key:"2"},Numpad3:{key:"3"},Numpad4:{key:"4"},Numpad5:{key:"5"},Numpad6:{key:"6"},Numpad7:{key:"7"},Numpad8:{key:"8"},Numpad9:{key:"9"},NumpadMultiply:{key:"*"},NumpadAdd:{key:"+"},NumpadComma:{key:","},NumpadSubtract:{key:"-"},NumpadDecimal:{key:"."},NumpadDivide:{key:"/"},Semicolon:{key:";",shiftKey:":"},Equal:{key:"=",shiftKey:"+"},Comma:{key:",",shiftKey:"<"},
Minus:{key:"-",shiftKey:"_"},Period:{key:".",shiftKey:">"},Slash:{key:"/",shiftKey:"?"},Backquote:{key:"`",shiftKey:"~"},BracketLeft:{key:"[",shiftKey:"{"},Backslash:{key:"\\",shiftKey:"|"},BracketRight:{key:"]",shiftKey:"}"},Quote:{key:"'",shiftKey:'"'},IntlBackslash:{key:"\\",shiftKey:"|"}};c(w,"mac",{OSLeft:{key:"Meta"},OSRight:{key:"Meta"}});var x={Esc:"Escape",Nonconvert:"NonConvert",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Menu:"ContextMenu",MediaNextTrack:"MediaTrackNext",
MediaPreviousTrack:"MediaTrackPrevious",SelectMedia:"MediaSelect",HalfWidth:"Hankaku",FullWidth:"Zenkaku",RomanCharacters:"Romaji",Crsel:"CrSel",Exsel:"ExSel",Zoom:"ZoomToggle"},B=function(a,b){var c={};Object.keys(a).forEach(function(d){d=a[d];b in d&&(c[d[b]]=d)});return c}(n,"code");try{var A=g&&"location"in new KeyboardEvent("")}catch(v){}"KeyboardEvent"in a&&"defineProperty"in Object&&function(){function a(b,c,d){c in b||Object.defineProperty(b,c,d)}a(KeyboardEvent.prototype,"code",{get:function(){var a=
d(this);return a?a.code:""}});if("key"in KeyboardEvent.prototype){var b=Object.getOwnPropertyDescriptor(KeyboardEvent.prototype,"key");Object.defineProperty(KeyboardEvent.prototype,"key",{get:function(){var a=b.get.call(this);return x.hasOwnProperty(a)?x[a]:a}})}a(KeyboardEvent.prototype,"key",{get:function(){var a=d(this);return a&&"key"in a?a.key:"Unidentified"}});a(KeyboardEvent.prototype,"location",{get:function(){var a=d(this);return a&&"location"in a?a.location:t}});a(KeyboardEvent.prototype,
"locale",{get:function(){return""}})}();"queryKeyCap"in a.KeyboardEvent||(a.KeyboardEvent.queryKeyCap=e);a.identifyKey=function(a){if(!("code"in a)){var b=d(a);a.code=b?b.code:"";a.key=b&&"key"in b?b.key:"Unidentified";a.location="location"in a?a.location:"keyLocation"in a?a.keyLocation:b&&"location"in b?b.location:t;a.locale=""}}})(window);function CustomEventTarget(){var a=document.createDocumentFragment();this.addEventListener=function(b,c){a.addEventListener(b,c,!0)};this.removeEventListener=function(b,c){a.removeEventListener(b,c,!0)};this.dispatchEvent=function(b){a.dispatchEvent(b)};this.emit=function(a,c){this.dispatchEvent(new CustomEvent(a,{detail:c}))}};(function(a,b,c){function d(a){this._=a;this.currentTarget=a.currentTarget}if(!(!(c=!!a.pointerEnabled)&&!a.msPointerEnabled||"ontouchend"in b)){var e=c?"setPointerCapture":"msSetPointerCapture",g=c?"releasePointerCapture":"msReleasePointerCapture";a=Element.prototype;var m=Object.defineProperties,t=Object.defineProperty,k=function(a){var b=a.toLowerCase();a="MS"+a;E[a]=E[b];return c?b:a},l=function(a){return{value:function(){B[a].call(this);this._[a]()}}},h=function(a){var b="_on"+a;return{enumerable:!0,
configurable:!0,get:function(){return this[b]||null},set:function(c){this[b]&&this.removeEventListener(a,this[b]);(this[b]=c)&&this.addEventListener(a,c)}}},r=function(a,b){var c=a[b];t(a,b,{configurable:!0,value:function(a,b,d){a in v&&c.call(this,v[a],F,d);c.call(this,a,b,d)}})},q=function(a){return{get:function(){return this._[a]}}},y=function(a){return function(b){var c=b.pointerId,d=w[c],e=b.currentTarget;delete w[c];if(g in e)e[g](b.pointerId);n(a,b,d);delete x[c]}},n=function(a,c,d){var e=
b.createEvent("Event");e.initEvent(a,!0,!0);p.value=c;A.currentTarget.value=d.currentTarget;m(e,A);d.currentTarget.dispatchEvent(e)},f=function(a,b){function c(a){return b[a]}return function(){p.value=Object.keys(b).map(c);return t(this,a,p)[a]}},p={value:null},w=Object.create(null),x=Object.create(null),B=b.createEvent("Event"),A={_:p,touches:{configurable:!0,get:f("touches",w)},changedTouches:{configurable:!0,get:f("changedTouches",x)},currentTarget:{value:null},relatedTarget:q("relatedTarget"),
target:q("target"),altKey:q("altKey"),metaKey:q("metaKey"),ctrlKey:q("ctrlKey"),shiftKey:q("shiftKey"),preventDefault:l("preventDefault"),stopPropagation:l("stopPropagation"),stopImmediatePropagation:l("stopImmediatePropagation")},v=Object.create(null),F=function(a){var b;a:{switch(a.pointerType){case "mouse":case a.MSPOINTER_TYPE_MOUSE:b="mouse";break a}b="touch"}if("touch"===b)E[a.type](a)},E={pointerdown:function(a){var b=new d(a),c=a.pointerId,f=a.currentTarget;x[c]=w[c]=b;if(e in f)f[e](a.pointerId);
n("touchstart",a,b)},pointermove:function(a){var b=a.pointerId,c=w[b];c._=a;n("touchmove",a,c);x[b]._=a},pointerup:y("touchend"),pointercancel:y("touchcancel")},l={ontouchstart:h("touchstart"),ontouchmove:h("touchmove"),ontouchend:h("touchend"),ontouchcancel:h("touchcancel")};m(d.prototype,{identifier:q("pointerId"),target:q("target"),screenX:q("screenX"),screenY:q("screenY"),clientX:q("clientX"),clientY:q("clientY"),pageX:q("pageX"),pageY:q("pageY")});v.touchstart=k("PointerDown");v.touchmove=k("PointerMove");
v.touchend=k("PointerUp");v.touchcancel=k("PointerCancel");r(b,"addEventListener");r(b,"removeEventListener");r(a,"addEventListener");r(a,"removeEventListener");m(b,l);m(a,l)}})(navigator,document);function Vector(a,b){this.x=a;this.y=b}Vector.createFromPolar=function(a,b){return new Vector(b*Math.cos(a),b*Math.sin(a))};Vector.prototype.add=function(a){this.x+=a.x;this.y+=a.y;return this};Vector.prototype.multiply=function(a){this.x*=a;this.y*=a;return this};Vector.prototype.distanceFrom=function(a){var b=a.y-this.y;return Math.sqrt(Math.pow(a.x-this.x,2)+Math.pow(b,2))};Vector.prototype.length=function(){return this.distanceFrom(Vector.zero)};
Vector.prototype.substractToNew=function(a){return new Vector(this.x-a.x,this.y-a.y)};Vector.prototype.toUnitVector=function(){return this.multiply(1/this.length())};Vector.prototype.toString=function(){return"("+this.x+", "+this.y+")"};Vector.prototype.clone=function(){return new Vector(this.x,this.y)};Vector.zero=new Vector(0,0);function ViewPort(){this.setBaseSize(1024,768);this.setModelViewPort(0,0,1024,768)}ViewPort.prototype.setBaseSize=function(a,b){this.baseWidth=a;this.baseHeight=b;this.modelAspectRatio=this.baseWidth/this.baseHeight};ViewPort.prototype.setViewSize=function(a,b){this.viewWidth=a;this.viewHeight=b;this.viewToBaseRatio=this.viewHeight/this.baseHeight;this.horizontalViewShift=(this.viewWidth-this.baseWidth*this.viewToBaseRatio)/2};
ViewPort.prototype.setModelViewPort=function(a,b,c,d){var e=c,g=d;g*this.modelAspectRatio>e?(e=Math.round(g*this.modelAspectRatio),a-=(e-c)/2):(g=Math.round(e/this.modelAspectRatio),b-=(g-d)/2);this.modelViewPort={x:a,y:b,width:e,height:g,center:new Vector(a+e/2,b+g/2)};this.zoom=this.baseWidth/e;this.viewScale=this.zoom*this.viewToBaseRatio};
ViewPort.prototype.setModelViewPortWithCenterZoom=function(a,b){var c=Math.round(this.baseWidth/b),d=Math.round(this.baseHeight/b);this.setModelViewPort(Math.round(a.x-c/2),Math.round(a.y-d/2),c,d)};ViewPort.prototype.projectToView=function(a){return new Vector((a.x-this.modelViewPort.x)*this.viewScale+this.horizontalViewShift,(a.y-this.modelViewPort.y)*this.viewScale)};
ViewPort.prototype.projectToModel=function(a){return new Vector((a.x-this.horizontalViewShift)/this.viewScale+this.modelViewPort.x,a.y/this.viewScale+this.modelViewPort.y)};ViewPort.prototype.isInView=function(a,b){var c=this.projectToView(a),d=(b||0)*this.viewScale;return c.x>=-d&&c.y>=-d&&c.x<this.viewWidth+d&&c.y<this.viewHeight+d?c:!1};function DOMViewPort(a){ViewPort.call(this);a&&(this.viewElement=a,this.notifyViewSizeChange(),this.resizeListener=this.notifyViewSizeChange.bind(this),window.addEventListener("resize",this.resizeListener))}DOMViewPort.prototype=Object.create(ViewPort.prototype);DOMViewPort.prototype.constructor=DOMViewPort;DOMViewPort.prototype.notifyViewSizeChange=function(){this.setViewSize(this.viewElement.clientWidth,this.viewElement.clientHeight)};
DOMViewPort.prototype.freeResources=function(){window.removeEventListener("resize",this.resizeListener)};function GameEngine(a){this.fps=a||30;this.stepTime=1E3/this.fps;this.stepsTaken=0;this.avgStepsPerCB=1;this.interval=null}GameEngine.prototype.getTS=function(){return window.performance&&window.performance.now?window.performance.now():Date.now()};GameEngine.prototype.start=function(){this.startTS=this.getTS();this.interval=setInterval(this.timerCB.bind(this),this.stepTime)};GameEngine.prototype.stop=function(){null!==this.interval&&(clearInterval(this.interval),this.interval=null)};
GameEngine.prototype.oneStep=function(){this.stepsTaken+=1};GameEngine.prototype.timerCB=function(){for(var a=this.getTS()-this.startTS,b=0;3>b&&this.stepsTaken*this.stepTime<=a;)this.oneStep(),b+=1;this.avgStepsPerCB=.95*this.avgStepsPerCB+.05*b};function Simulation(a){GameEngine.call(this,a);CustomEventTarget.call(this);this.spaceObjects=[];this.objectsToRemove=[]}Simulation.prototype=Object.create(GameEngine.prototype);Simulation.prototype.constructor=Simulation;Simulation.prototype.start=function(){this.setUpModel();GameEngine.prototype.start.call(this);this.emit("start")};Simulation.prototype.stop=function(){GameEngine.prototype.stop.call(this);this.emit("stop")};Simulation.prototype.setUpModel=function(){console.log("Default setUpModel, you have to override it!")};
Simulation.prototype.addSpaceObject=function(a){this.spaceObjects.push(a);a.simulation=this;this.emit("spaceobjectadded",{spaceObject:a})};Simulation.prototype.removeSpaceObject=function(a){this.objectsToRemove.push(a)};
Simulation.prototype.purgeSpaceObjects=function(){for(var a=this.objectsToRemove.length-1;0<=a;){for(var b=this.objectsToRemove[a],c=this.spaceObjects.length-1;0<=c;){if(this.spaceObjects[c]===b){this.spaceObjects.splice(c,1);this.emit("spaceobjectremoved",{spaceObject:b});break}c--}a--}this.objectsToRemove=[]};
Simulation.prototype.oneStep=function(){for(var a=this.spaceObjects.length,b=this.spaceObjects,c=0,d,e,g;c<a;){e=b[c];for(var m=c+1;m<a;m++)d=b[m],g=SpaceObject.actGravityForce(e,d),e.actOn(d,g),d.actOn(e,g),g<d.radius+e.radius-8&&!d.permeable&&this.emit("collision",{first:e,second:d});e.oneStep();c++}this.purgeSpaceObjects();this.emit("onesteptaken");GameEngine.prototype.oneStep.call(this)};
Simulation.prototype.getState=function(){var a={};a.stepsTaken=this.stepsTaken;a.spaceObjects=this.spaceObjects.map(SpaceObject.prototype.toPOJO);return a};Simulation.prototype.setState=function(a){var b=this;this.stepsTaken=a.stepsTaken||0;a.spaceObjects&&a.spaceObjects.forEach(function(a){b.addSpaceObject(SpaceObject.createFromPOJO(a))});return a};
Simulation.defaultState={spaceObjects:[{pos:{x:0,y:0},v:{x:0,y:0},mass:.1,reciprocalMass:10,heading:0,angularSpeed:0,radius:20,id:"SO14",enginePowered:{fuel:null,engineRunning:!1},permeable:!1,isIndestructible:!1,type:"SpaceShip"}],stepsTaken:0};function SimulationDistributor(a,b,c){this.simulation=a;this.connection=b;this.fps=c||30;this.lastSendTS=0;this.externalObjects={};this.ownedObjects={};this.connect();a.addEventListener("onesteptaken",this.oneStepTaken.bind(this));a.addEventListener("spaceobjectadded",this.spaceObjectAdded.bind(this))}SimulationDistributor.prototype.connect=function(){this.connection.onmessage=this.messageReceived.bind(this)};
SimulationDistributor.prototype.messageReceived=function(a){var b=this;JSON.parse(a.data).spaceObjects.forEach(function(a){var d=b.externalObjects[a.id];d?LangUtils.deepMerge(d,a):(b.ownedObjects[a.id]&&console.error(a.id+" is owned by me, not accepting external update!"),d=SpaceObject.createFromPOJO(a),b.externalObjects[d.id]=d,b.simulation.addSpaceObject(d))})};
SimulationDistributor.prototype.oneStepTaken=function(){if(!(Date.now()-this.lastSendTS<1E3/this.fps)){this.lastSendTS=Date.now();var a=this.simulation.getState(),b=this;this.connection.send(JSON.stringify({spaceObjects:a.spaceObjects.filter(function(a){return!!b.ownedObjects[a.id]})}))}};SimulationDistributor.prototype.spaceObjectAdded=function(a){a=a.detail.spaceObject;this.externalObjects[a.id]||(this.ownedObjects[a.id]=a)};function SpaceObject(a,b,c,d,e){this.pos=a||new Vector(0,0);this.v=b||new Vector(0,0);this.mass=c||1;this.heading=d||0;this.angularSpeed=e||0;this.stepForce=new Vector(0,0);this.radius=20;this.id=SpaceObject.getNextId();this.simulation=null}SpaceObject.G=50;SpaceObject.prototype.permeable=!1;SpaceObject.prototype.isIndestructible=!1;
SpaceObject.actGravityForce=function(a,b){var c=a.pos.distanceFrom(b.pos);if(!(15>c)){var d=a.mass*b.mass*SpaceObject.G/Math.pow(c,2),d=a.pos.substractToNew(b.pos).toUnitVector().multiply(d);b.stepForce.add(d);a.stepForce.add(d.multiply(-1));return c}};SpaceObject.nextId=Math.round(1E6*Math.random());SpaceObject.getNextId=function(){var a="SO"+SpaceObject.nextId;SpaceObject.nextId+=1;return a};
SpaceObject.prototype.oneStep=function(){this.v.add(this.stepForce.multiply(1/this.mass));this.pos.add(this.v);this.heading+=this.angularSpeed;this.stepForce=new Vector(0,0)};SpaceObject.prototype.actOn=function(a,b){};SpaceObject.prototype.toString=function(){return" "+this.constructor.name};SpaceObject.prototype.clone=function(){var a=new this.constructor;LangUtils.deepMerge(a,this);return a};
SpaceObject.prototype.toPOJO=function(a){a=(a||this).clone();a.type=a.constructor.name;delete a.simulation;delete a.stepForce;return a};SpaceObject.createFromPOJO=function(a){var b=window[a.type];if(!b)return console.error("Unable to create type: "+a.type),new SpaceObject;b=new b;LangUtils.deepMerge(b,a);return b};function Star(a,b,c){SpaceObject.call(this,a,b,c||10);this.radius=135}Star.prototype=Object.create(SpaceObject.prototype);Star.prototype.constructor=Star;Star.prototype.isIndestructible=!0;function FixedStar(a,b,c){Star.call(this,a,b,c)}FixedStar.prototype=Object.create(Star.prototype);FixedStar.prototype.constructor=FixedStar;FixedStar.prototype.oneStep=function(){this.stepForce=Vector.zero.clone();SpaceObject.prototype.oneStep.call(this)};function FuelPack(a,b,c){SpaceObject.call(this,a,b,.001);this.radius=10;this.storedFuel=c||2E3}FuelPack.prototype=Object.create(SpaceObject.prototype);FuelPack.prototype.constructor=FuelPack;FuelPack.prototype.actOn=function(a,b){0<this.storedFuel&&b<a.radius+this.radius&&a.enginePowered&&this.tankTo(a)};FuelPack.prototype.tankTo=function(a){a.enginePowered.fuel+=this.storedFuel;this.storedFuel=0;this.simulation.removeSpaceObject(this)};function Planet(a,b,c){SpaceObject.call(this,a,b,c);this.radius=25}Planet.prototype=Object.create(SpaceObject.prototype);Planet.prototype.constructor=Planet;function SimulationCenter(a){var b=this.actOn||function(){};this.actOn=function(a,d){d>this.maxDistance&&!a.permeable&&(this.simulation.addSpaceObject(Detonation.createFromSpaceObject(a)),this.simulation.removeSpaceObject(a));b.call(this,a,d)}};function Earth(a,b,c,d){SpaceObject.call(this,a,b,c);this.radius=d;SimulationCenter.call(this)}Earth.prototype=Object.create(SpaceObject.prototype);Earth.prototype.constructor=Earth;Earth.prototype.isIndestructible=!0;Earth.prototype.oneStep=function(){this.stepForce=Vector.zero.clone();SpaceObject.prototype.oneStep.call(this)};Earth.prototype.actOn=function(a,b){if(!a.permeable&&b<this.radius+a.radius-10){var c=new Detonation(a.pos.clone(),Vector.zero.clone());this.simulation.addSpaceObject(c);this.simulation.removeSpaceObject(a)}};function Moon(a,b,c){SpaceObject.call(this,a,b,c);this.radius=15}Moon.prototype=Object.create(SpaceObject.prototype);Moon.prototype.constructor=Moon;function EnginePowered(a,b,c){var d=this.enginePowered={fuel:b||Infinity,engineRunning:c||!1,enginePower:a||.0015},e=this.oneStep;this.oneStep=function(){d.engineRunning&&(this.stepForce.add(Vector.createFromPolar(this.heading,d.enginePower)),0>=--d.fuel&&(d.engineRunning=!1));e.call(this)};this.startEngine=function(){0<d.fuel&&(d.engineRunning=!0)};this.stopEngine=function(){d.engineRunning=!1}};function Asteroid(a,b,c){SpaceObject.call(this,a,b,c,0,Math.random()/10-.05);this.radius=15}Asteroid.prototype=Object.create(SpaceObject.prototype);Asteroid.prototype.constructor=Asteroid;function MissileLauncher(a){a=a||500;var b=0;this.launchMissile=function(){if(0!==this.getTimeToNextMissile())return!1;var a=Vector.createFromPolar(this.heading,1),d=this.v.clone(),d=new Missile(this.pos.clone(),d,this.heading);d.pos.add(a.clone().multiply(this.radius+d.radius+5));this.simulation.addSpaceObject(d);b=Date.now();return!0};this.getTimeToNextMissile=function(){return Math.min(0,Date.now()-b-a)}};function SpaceDebris(a,b,c,d){SpaceObject.call(this,a,b,c,d);this.angularSpeed=.1*Math.random()-.05}SpaceDebris.prototype=Object.create(SpaceObject.prototype);SpaceDebris.prototype.constructor=SpaceDebris;function SpaceShip(a,b,c,d,e,g,m){SpaceObject.call(this,b,c,d,e);EnginePowered.call(this,g,m);MissileLauncher.call(this);this.radius=20;this.rotationEnginePower=.03/(a?a.fps:60)*100}SpaceShip.prototype=Object.create(SpaceObject.prototype);SpaceShip.prototype.constructor=SpaceShip;SpaceShip.prototype.startRotationLeft=function(){this.angularSpeed=-this.rotationEnginePower};SpaceShip.prototype.startRotationRight=function(){this.angularSpeed=this.rotationEnginePower};
SpaceShip.prototype.stopRotation=function(){this.angularSpeed=0};function Missile(a,b,c,d,e){SpaceObject.call(this,a,b,.001,c);EnginePowered.call(this,1E-4,e||60,!0);this.radius=10;this.lifeSteps=d||480;this.detonated=!1;this.permeable=!0}Missile.prototype=Object.create(SpaceObject.prototype);Missile.prototype.constructor=Missile;Missile.prototype.oneStep=function(){SpaceObject.prototype.oneStep.call(this);--this.lifeSteps;0>=this.lifeSteps&&!this.detonated&&(this.simulation.removeSpaceObject(this),this.detonate())};
Missile.prototype.actOn=function(a,b){b<a.radius+this.radius&&!this.detonated&&!a.permeable&&this.detonate(a)};Missile.prototype.detonate=function(a){if(!this.detonated){a=a||this;this.detonated=!0;var b=a.pos;a.isIndestructible&&(b=this.pos);b=new Detonation(b.clone(),Vector.zero.clone());this.simulation.addSpaceObject(b);this.simulation.removeSpaceObject(this);a.isIndestructible||this.simulation.removeSpaceObject(a)}};function Detonation(a,b){SpaceObject.call(this,a,b,-.15);this.permeable=!0;this.lifeSteps=100}Detonation.prototype=Object.create(SpaceObject.prototype);Detonation.prototype.constructor=Detonation;Detonation.prototype.oneStep=function(){this.stepForce=Vector.zero.clone();SpaceObject.prototype.oneStep.call(this);0>=--this.lifeSteps&&this.simulation.removeSpaceObject(this)};Detonation.createFromSpaceObject=function(a){return new Detonation(a.pos.clone(),Vector.zero.clone())};function Forecaster(a,b){this.source=a;this.steps=b||1800;this.stepsPerForecastPoint=15}
Forecaster.prototype.createForecast=function(){var a=this;this.simulation=new Simulation;this.simulation.emit=function(a,b){"collision"===a&&(b.first.isIndestructible||this.removeSpaceObject(b.first),b.second.isIndestructible||this.removeSpaceObject(b.second))};var b={};this.source.spaceObjects.forEach(function(c){a.simulation.addSpaceObject(c.clone());b[c.id]=[]});for(var c=this.steps/this.stepsPerForecastPoint,d=0;d<c;++d){for(var e=0;e<this.stepsPerForecastPoint;++e)this.simulation.oneStep();this.simulation.spaceObjects.forEach(function(a){b[a.id].push({x:a.pos.x,
y:a.pos.y})})}this.simulation.stop();this.simulation=null;return b};function RTCConnectionManager(){}RTCConnectionManager.getConnection=function(){var a=new RTCMultiConnection;a.socketURL="https://rtcmulticonnection.herokuapp.com:443/";a.session={audio:!1,video:!1,data:!0};a.sdpConstraints.mandatory={OfferToReceiveAudio:!1,OfferToReceiveVideo:!1};a.onstream=function(){console.log("onstream")};a.onopen=function(a){console.log("onopen");console.log(a)};a.openOrJoin("11111");return a};function Scene(a,b){this.simulation=a;this.renderer=b;this.simulation&&(this.simulation.setUpModel=this.setUpModel.bind(this))}Scene.prototype.setUpModel=function(){};Scene.prototype.addProtectedObjects=function(a){a.forEach(function(a){a.actOn=function(c,d){d<c.radius+a.radius-8&&!c.permeable&&(this.simulation.removeSpaceObject(a),this.simulation.addSpaceObject(Detonation.createFromSpaceObject(a)))}})};Scene.scenes={};Scene.registerScene=function(a){Scene.scenes[a.name]=a};
Scene.createScene=function(a,b,c){return new Scene.scenes[a](b,c)};function Objective(a,b,c){this.simulation=a;SimulationObserver.call(this,a);CustomEventTarget.call(this);this.winAtStep=b||-1;this.failAtStep=c||-1;this.stepCount=0;this.ended=!1}Objective.prototype.oneStepTaken=function(){this.stepCount+=1;this.stepCount==this.winAtStep&&this.emitWin();this.stepCount==this.failAtStep&&this.emitFail()};Objective.prototype.emitWin=function(){this.ended||(this.ended=!0,this.dispatchEvent(new CustomEvent("win")))};
Objective.prototype.emitFail=function(a){this.ended||(this.ended=!0,this.dispatchEvent(new CustomEvent("fail",{detail:a})))};function ProtectObjective(a,b,c){Objective.call(this,a,c);this.protectedObjects=b}ProtectObjective.prototype=Object.create(Objective.prototype);ProtectObjective.prototype.spaceObjectRemoved=function(a){-1!==this.protectedObjects.indexOf(a)&&this.emitFail({lostObject:a})};function DeathMatchScene(a,b){this.connection=RTCConnectionManager.getConnection();Scene.call(this,a,b)}DeathMatchScene.prototype=Object.create(Scene.prototype);DeathMatchScene.prototype.constructor=DeathMatchScene;Scene.registerScene(DeathMatchScene);
DeathMatchScene.prototype.setUpModel=function(){var a=this.simulation;this.distributor=new SimulationDistributor(this.simulation,this.connection);var b=new SpaceShip(a,new Vector(500,280),new Vector(1,0),.1,0);a.addSpaceObject(b);this.createWorld();var c=[b];this.addProtectedObjects(c);this.objective=new ProtectObjective(a,c);a=new OutlineCamera(new SimpleCamera(this.simulation,this.renderer.viewPort,b),0,0,2E3,1500);this.renderer.setCamera(a);this.keyboardController=new KeyboardController(b,a);(this.touchController=
TouchController.createControllerFor(b,a))&&this.renderer.viewElement.appendChild(this.touchController.view.rootElement)};DeathMatchScene.prototype.createWorld=function(){var a=new FixedStar(new Vector(1E3,750),new Vector(0,0),10);this.simulation.addSpaceObject(a)};function GravityAssistScene(a,b){Scene.call(this,a,b)}GravityAssistScene.prototype=Object.create(Scene.prototype);GravityAssistScene.prototype.constructor=GravityAssistScene;Scene.registerScene(GravityAssistScene);
GravityAssistScene.descriptor={spaceObjects:[{pos:{x:-578.8176466899788,y:1164.4366574046458},v:{x:0,y:0},mass:.1,heading:0,angularSpeed:0,radius:20,id:"SO14",enginePowered:{fuel:null,engineRunning:!1,enginePower:3E-4},reciprocalMass:10,permeable:!1,isIndestructible:!1,type:"SpaceShip"},{pos:{x:2081.714285714285,y:1040.2733516483515},v:{x:-1,y:-1},mass:20,heading:0,angularSpeed:0,radius:80,id:"SO94",permeable:!1,isIndestructible:!1,type:"Planet"},{pos:{x:497.543269230801,y:-1769.4069368132118},v:{x:-.034,
y:1},mass:1.1,heading:0,angularSpeed:0,radius:20,id:"SO891",isIndestructible:!0,permeable:!1,type:"Moon"},{pos:{x:49.832959880704244,y:1664.5328729758112},v:{x:-.296,y:-1.302},mass:2,heading:0,angularSpeed:0,radius:15,id:"SO251",permeable:!1,isIndestructible:!0,type:"Moon"}],stepsTaken:0};
GravityAssistScene.prototype.setUpModel=function(){var a=this.simulation;a.setState(GravityAssistScene.descriptor);var b=a.spaceObjects[0],c=a.spaceObjects.map(function(a){return a});this.addProtectedObjects(c);this.objective=new ProtectObjective(a,c,1900);a=new OutlineCamera(new SimpleCamera(this.simulation,this.renderer.viewPort,b),-1E3,-1500,2E3,2800);this.renderer.setCamera(a);new KeyboardController(b,a);(b=TouchController.createControllerFor(b,a))&&this.renderer.viewElement.appendChild(b.view.rootElement)};function PuzzleScene(a,b){Scene.call(this,a,b)}PuzzleScene.prototype=Object.create(Scene.prototype);PuzzleScene.prototype.constructor=PuzzleScene;Scene.registerScene(PuzzleScene);
PuzzleScene.prototype.setUpModel=function(){var a=this.simulation,b=new SpaceShip(a,new Vector(500,350),new Vector(3,0),.1,0),c=new Planet(new Vector(400,350),new Vector(-.3,.3),15),d=new Moon(new Vector(400,650),new Vector(-1.3,.3),1),e=new FixedStar(new Vector(1400,1050),new Vector(0,0),10);e.isIndestructible=!1;var g=[new Asteroid(new Vector(200,0),new Vector(2,.1),.1),new Asteroid(new Vector(1600,1350),new Vector(.3,-1.51),1),new Asteroid(new Vector(2900,1750),new Vector(-.7,-.28),1)];a.addSpaceObject(b);
a.addSpaceObject(c);a.addSpaceObject(d);g.forEach(a.addSpaceObject.bind(a));a.addSpaceObject(e);c=[b,c,d,e];this.addProtectedObjects(c);this.objective=new ProtectObjective(a,c,1800);a=new OutlineCamera(new SimpleCamera(this.simulation,this.renderer.viewPort,b),0,0,3E3,1800);this.renderer.setCamera(a);new KeyboardController(b,a);(b=TouchController.createControllerFor(b,a))&&this.renderer.viewElement.appendChild(b.view.rootElement)};function SpaceDebrisScene(a,b){Scene.call(this,a,b)}SpaceDebrisScene.prototype=Object.create(Scene.prototype);SpaceDebrisScene.prototype.constructor=SpaceDebrisScene;Scene.registerScene(SpaceDebrisScene);
SpaceDebrisScene.prototype.setUpModel=function(){var a=this.simulation,b=this,c=new SpaceShip(a,new Vector(400,-550),new Vector(3.3,0),.1,0,.0012,600),d=new Earth(new Vector(400,350),new Vector(0,0),210,755);d.maxDistance=2500;var e=new FuelPack(new Vector(500,-580),new Vector(3.2,0));a.addSpaceObject(c);a.addSpaceObject(d);a.addSpaceObject(e);setInterval(function(){25>a.spaceObjects.length&&b.generateObject(d)},10);this.objective=new ProtectObjective(a,[c]);e=new OutlineCamera(new SimpleCamera(this.simulation,
this.renderer.viewPort,c),-800,-850,2400,2400);this.renderer.setCamera(e);new KeyboardController(c,e);(c=TouchController.createControllerFor(c,e))&&this.renderer.viewElement.appendChild(c.view.rootElement)};SpaceDebrisScene.prototype.generateObject=function(a){var b=null;(b=.15<Math.random()?this.placeRandomly(new SpaceDebris,a,800,1100,this.renderer.viewPort):this.placeRandomly(new FuelPack,a,800,1100,this.renderer.viewPort))&&this.simulation.addSpaceObject(b)};
SpaceDebrisScene.prototype.placeRandomly=function(a,b,c,d,e){var g=Math.random()*Math.PI*2;c=Math.random()*(d-c)+c;d=Vector.createFromPolar(g,c);b=b.pos.clone().add(d);return e.isInView(b,20)?null:(e=Math.sqrt((1E4+500*Math.random())/c),a.pos=b,a.v=Vector.createFromPolar(g-Math.PI/2,-e),a)};window.LocalScenes=function(){var a={},b=[];a.getList=function(){return b};a.get=function(a){(a=b[a])||(a=JSON.stringify(Simulation.defaultState));return a};a.set=function(a,d){b[a]=d;localStorage["savedscene_"+a]=b[a]};a.add=function(a){b.push(a);a=b.length-1;localStorage["savedscene_"+a]=b[a];return a};(function(){b=[];for(var a=0,d=localStorage["savedscene_"+a];d;)b.push(d),a+=1,d=localStorage["savedscene_"+a];for(;6>a;)b.push(""),a+=1})();return a}();function Sound(){}Sound.prototype.playMusic=function(a){window.Media?(this.stopMusic(),a=this.createLocalMediaUrl(a),this.runningMusic=new Media(a,function(){console.log("playMusic(): Audio Success")},function(a){console.log("playMusic():Audio Error: "+JSON.stringify(a))}),this.runningMusic.play()):console.log("playMusic: Media plugin not found")};Sound.prototype.stopMusic=function(){this.runningMusic&&(this.runningMusic.stop(),this.runningMusic.release())};
Sound.prototype.createLocalMediaUrl=function(a){if(window.device&&"Android"==window.device.platform){var b=window.location.pathname,b=b.substr(b,b.lastIndexOf("/"));b.startsWith("http")||b.startsWith("file")||(b="file://"+b);return b+"/"+a}return a};function Camera(a,b){this.simulation=a;this.viewPort=b}Camera.prototype.updateView=function(){};function SimpleCamera(a,b,c){Camera.call(this,a,b);this.centerObject=c}SimpleCamera.prototype=Object.create(Camera.prototype);SimpleCamera.prototype.constructor=SimpleCamera;SimpleCamera.prototype.updateView=function(){this.viewPort.setModelViewPortWithCenterZoom(this.centerObject.pos.clone().add(this.centerObject.v.clone().multiply(50)),1)};function OutlineCamera(a,b,c,d,e){Camera.call(this,a.simulation,a.viewPort);this.originalCamera=a;this.isOutLined=!1;this.x=b||0;this.width=d||2048;this.y=c||0;this.height=e||1536;this.animationLength=500}OutlineCamera.prototype=Object.create(Camera.prototype);OutlineCamera.prototype.constructor=OutlineCamera;OutlineCamera.prototype.updateView=function(){this.animationRunning&&this.animate()||(this.isOutlined?this.viewPort.setModelViewPort(this.x,this.y,this.width,this.height):this.originalCamera.updateView())};
OutlineCamera.prototype.animate=function(){function a(a,b,c){return a+c*(b-a)}var b=(Date.now()-this.animationStartedAt)/this.animationLength;if(1<=b)return this.animationRunning=!1;this.isOutlined||(b=1-b);this.originalCamera.updateView();var c=a(this.viewPort.modelViewPort.x,this.x,b),d=a(this.viewPort.modelViewPort.y,this.y,b),e=a(this.viewPort.modelViewPort.width,this.width,b),b=a(this.viewPort.modelViewPort.height,this.height,b);this.viewPort.setModelViewPort(c,d,e,b);return!0};
OutlineCamera.prototype.setOutlined=function(a){this.isOutlined=a;this.animationRunning=!0;this.animationStartedAt=Date.now()};OutlineCamera.prototype.switchOutlined=function(){this.setOutlined(!this.isOutlined)};function SimulationObserver(a){if(this.simulation=a){var b=this,c=function(a){b.spaceObjectAdded(a.detail.spaceObject)},d=function(a){b.spaceObjectRemoved(a.detail.spaceObject)},e=function(a){b.oneStepTaken()},g=function(a){b.collision()},m=function(a){b.simulationStopped&&b.simulationStopped();b.unbindFromSimulation()};b.spaceObjectAdded&&a.addEventListener("spaceobjectadded",c);b.spaceObjectRemoved&&a.addEventListener("spaceobjectremoved",d);b.oneStepTaken&&a.addEventListener("onesteptaken",e);
b.collision&&a.addEventListener("collision",g);a.addEventListener("stop",m);b.unbindFromSimulation=function(){b.simulation.removeEventListener("spaceobjectadded",c);b.simulation.removeEventListener("spaceobjectremoved",d);b.simulation.removeEventListener("onesteptaken",e);b.simulation.removeEventListener("collision",g);b.simulation.removeEventListener("stop",m)}}};function View(a,b,c,d){b&&("object"===typeof d&&(this.projection=d),(this.rootElement=this.createRootElement(a,b))?(c&&(c instanceof View&&(c=c.rootElement),this.containingElement=c,this.containingElement.appendChild(this.rootElement)),this.viewElements=this.loadElementsToObject("[data-field]","data-field"),this.setModel(a),this.loadLists()):console.error('Template "'+b+'" not found.'))}View.prototype.idPrefix="view_";View.prototype.templateId="view";View.prototype.projection={};
View.prototype.createRootElement=function(a,b){b=b||this.templateId;var c=document.getElementById(b);if(!c)return null;var c=c.cloneNode(!0),d=a&&a.id?a.id:"auto"+Math.round(1E5*Math.random());c.id=d;c.view_model=a;c.classList.remove("template");return c};View.prototype.loadLists=function(){var a=this.loadElementsToObject("[data-list]","data-list");this.lists={};for(var b in a)this.lists[b]=new ListView(this.model[b],a[b],this.projection[b])};
View.prototype.loadElementsToObject=function(a,b){if(this.rootElement){var c={};Array.from(this.rootElement.querySelectorAll(a)).forEach(function(a){c[a.getAttribute(b)]=a});return c}};View.prototype.calculateFieldValue=function(a){try{var b=this.projection[a];return"undefined"===typeof b?this.model[a]:"function"==typeof b?b.call(this):b}catch(c){return"N/A"}};
View.prototype.updateField=function(a){var b=this.viewElements[a];a=this.calculateFieldValue(a);if(a.class){var c=a.class,d;for(d in c)c[d]?b.classList.add(d):b.classList.remove(d);a.class=null}"object"===typeof a?LangUtils.deepMerge(b,a):b.textContent=a};View.prototype.updateAll=function(){for(var a in this.viewElements)this.updateField(a)};View.prototype.setModel=function(a){this.model=a;this.updateAll()};
View.prototype.getModelForElement=function(a){for(;a;){if(a.view_model)return a.view_model;a=a.parentNode}};View.prototype.show=function(a){this.rootElement.style.visibility=!1===a?"hidden":"visible"};function ListView(a,b,c){this.model=a;this.templateId=b.getAttribute("data-template");this.rootElement=b;this.projection=c;this.createSubViews()}ListView.prototype.createSubViews=function(){this.subViews=[];var a=this;this.model.forEach(function(b){a.subViews.push(Controller.createForTemplate(a.templateId,b,a.rootElement,a.projection))})};function Renderer(a,b){SimulationObserver.call(this,a);this.simulation=a;this.viewElement=b;this.redrawNeeded=!0;this.viewPort=new DOMViewPort(b);this.camera=null;this.stopped=!1}Renderer.prototype.start=function(){window.requestAnimationFrame(this.tick.bind(this));this.stopped=!1};Renderer.prototype.stop=function(){this.unbindFromSimulation();this.viewPort.freeResources();this.stopped=!0};Renderer.prototype.tick=function(){this.stopped||(this.redrawNeeded&&(this.redraw(),this.redrawNeeded=!1),window.requestAnimationFrame(this.tick.bind(this)))};
Renderer.prototype.redraw=function(){console.log("Override redraw!")};Renderer.prototype.oneStepTaken=function(){this.redrawNeeded=!0};Renderer.prototype.setCamera=function(a){this.camera=a};Renderer.prototype.spaceObjectAdded=function(){this.redrawNeeded=!0};Renderer.prototype.spaceObjectRemoved=function(){this.redrawNeeded=!0};function CanvasRenderer(a,b,c){this.area=new View({},c||"Area",b);Renderer.call(this,a,this.area.rootElement);this.views=[];this.backgroundSpeedRatio=2;this.defaultBgSize=1024;this.displayedViewCount=0;this.canvas=this.area.rootElement.querySelector("canvas");this.area.rootElement.appendChild(this.canvas);this.ctx=this.canvas.getContext("2d")}CanvasRenderer.prototype=Object.create(Renderer.prototype);CanvasRenderer.prototype.constructor=CanvasRenderer;CanvasRenderer.viewClasses=[];
CanvasRenderer.prototype.stop=function(){this.area.rootElement.parentNode.removeChild(this.area.rootElement);Renderer.prototype.stop.call(this)};CanvasRenderer.registerViewClass=function(a,b){CanvasRenderer.viewClasses[a]=b};CanvasRenderer.prototype.redraw=function(){this.updateCanvasSize();this.camera.updateView();this.updateBackground();for(var a=this.views.length,b=this.displayedViewCount=0;b<a;b++)this.updateView(this.views[b])};
CanvasRenderer.prototype.updateCanvasSize=function(){if(this.canvas.width!=this.viewElement.clientWidth||this.canvas.height!=this.viewElement.clientHeight)this.canvas.width=this.viewElement.clientWidth,this.canvas.height=this.viewElement.clientHeight};CanvasRenderer.prototype.spaceObjectAdded=function(a){Renderer.prototype.spaceObjectAdded.call(this,a);var b=this.createView(a);a instanceof SpaceShip&&(this.ship=b)};
CanvasRenderer.prototype.spaceObjectRemoved=function(a){Renderer.prototype.spaceObjectRemoved.call(this,a);for(var b=this.views.length-1;0<=b;){if(this.views[b].model===a){this.views.splice(b,1);break}b--}};CanvasRenderer.prototype.createView=function(a){var b=a.constructor.name.toLowerCase(),c=CanvasRenderer.viewClasses[b];if(!c)throw"No View class for "+b;a=new c(a,this.viewPort);this.views.push(a);return a};CanvasRenderer.prototype.updateView=function(a){try{a.drawTo(this.ctx)}catch(b){console.warn(b)}this.displayedViewCount++};
CanvasRenderer.prototype.updateBackground=function(){function a(a,b){for(a%=b;0<a;)a-=b;return a}this.backgroundImage||(this.backgroundImage=CanvasView.loadImage("background"));var b=this.viewPort.modelViewPort.center,c=1+(this.viewPort.viewScale-1)/this.backgroundSpeedRatio,d=Math.round(c*this.defaultBgSize),e=Math.round(d*this.backgroundImage.width/this.backgroundImage.height);if(!(100>d||100>e))for(var g=a(Math.round(-b.x/this.backgroundSpeedRatio*c),d),b=a(Math.round(-b.y/this.backgroundSpeedRatio*
c),e);g<this.canvas.width;){for(c=b;c<this.canvas.height;)this.ctx.drawImage(this.backgroundImage,g,c,d,e),c+=e;g+=d}};function CanvasView(a,b,c){this.model=a;this.viewPort=b;this.parts=c||[];this.maxAge=Infinity;this.createdAt=Date.now()}CanvasView.modelName="spaceobject";CanvasView.images={};CanvasRenderer.registerViewClass(CanvasView);CustomEventTarget.call(CanvasView);
CanvasView.prototype.drawImage=function(a){var b=a.offsetX||0,c=a.offsetY||0;this.ctx.translate(this.projectedPos.x,this.projectedPos.y);this.ctx.rotate(this.model.heading);this.ctx.scale(this.viewPort.viewScale,this.viewPort.viewScale);this.ctx.translate(b,c);this.ctx.globalAlpha="undefined"===typeof a.alpha?1:a.alpha;this.ctx.drawImage(a.image,Math.round(-a.width/2),Math.round(-a.height/2),a.width,a.height)};
CanvasView.prototype.drawPart=function(a){if(this.projectedPos=this.viewPort.isInView(this.model.pos,this.model.radius))this.ctx.save(),this.drawImage(a),this.ctx.restore()};CanvasView.prototype.drawTo=function(a){this.ctx=a;a=Math.min(Date.now()-this.createdAt,this.maxAge);this.calcAnimationState(a);this.parts.forEach(this.drawPart.bind(this))};CanvasView.prototype.calcAnimationState=function(a){return a};
CanvasView.loadImage=function(a){if(CanvasView.images[a])return CanvasView.images[a];CanvasView.emit("loadstart",a);var b=new Image;b.addEventListener("load",function(){CanvasView.emit("load",a)});b.addEventListener("error",function(){console.error("Unable to load image: "+a);CanvasView.emit("error",a)});b.src="img/"+a+".png";b.width=60;b.height=60;return CanvasView.images[a]=b};
CanvasView.sphere=function(a,b,c){return{image:CanvasView.loadImage(a),get width(){return 2*b.radius},get height(){return 2*b.radius}}};function AteroidCanvasView(a,b){CanvasView.call(this,a,b,[CanvasView.sphere("earth",a)])}AteroidCanvasView.prototype=Object.create(CanvasView.prototype);CanvasRenderer.registerViewClass("asteroid",AteroidCanvasView);function EnginePoweredCanvasView(a){var b=a||EnginePoweredCanvasView.defaultFlame;this.parts.unshift(b);var c=!1,d=a.width,e=a.offsetX,g;this.calcAnimationState=function(a){c!==this.model.enginePowered.engineRunning&&(c=this.model.enginePowered.engineRunning,g=a);a=Math.min((a-g)/200,1);a=c?a:1-a;b.alpha=1.5-a;b.width=d*a;b.offsetX=-20+e*a}}EnginePoweredCanvasView.defaultFlame={image:CanvasView.loadImage("doubleflame"),width:120,height:30,offsetX:-77,offsetY:0};function DetonationCanvasView(a,b){var c={image:CanvasView.loadImage("detonation"),width:400,height:400,alpha:0};CanvasView.call(this,a,b,[c]);this.detonationImage=c;this.maxAge=1E3}DetonationCanvasView.prototype=Object.create(CanvasView.prototype);CanvasRenderer.registerViewClass("detonation",DetonationCanvasView);
DetonationCanvasView.prototype.calcAnimationState=function(a){a/=this.maxAge;this.detonationImage.alpha=1-a;this.detonationImage.width=Math.round(500*a);this.detonationImage.height=Math.round(500*a)};function EarthCanvasView(a,b){CanvasView.call(this,a,b,[CanvasView.sphere("earth",a)])}EarthCanvasView.prototype=Object.create(CanvasView.prototype);CanvasRenderer.registerViewClass("earth",EarthCanvasView);function FuelPackView(a,b){CanvasView.call(this,a,b,[CanvasView.sphere("fuelpack",a)])}FuelPackView.prototype=Object.create(CanvasView.prototype);CanvasRenderer.registerViewClass("fuelpack",FuelPackView);function MoonCanvasView(a,b){CanvasView.call(this,a,b,[CanvasView.sphere("moon",a)])}MoonCanvasView.prototype=Object.create(CanvasView.prototype);CanvasRenderer.registerViewClass("moon",MoonCanvasView);function MissileCanvasView(a,b){CanvasView.call(this,a,b,[{image:CanvasView.loadImage("missile"),width:30,height:12}]);var c={image:CanvasView.loadImage("flame"),width:50,height:10,offsetX:-18,offsetY:0};EnginePoweredCanvasView.call(this,c)}MissileCanvasView.prototype=Object.create(CanvasView.prototype);CanvasRenderer.registerViewClass("missile",MissileCanvasView);function PlanetCanvasView(a,b){CanvasView.call(this,a,b,[CanvasView.sphere("planet",a)])}PlanetCanvasView.prototype=Object.create(CanvasView.prototype);CanvasRenderer.registerViewClass("planet",PlanetCanvasView);function SpaceDebrisCanvasView(a,b){CanvasView.call(this,a,b,[CanvasView.sphere("spacedebris",a)])}SpaceDebrisCanvasView.prototype=Object.create(CanvasView.prototype);CanvasRenderer.registerViewClass("spacedebris",SpaceDebrisCanvasView);function SpaceShipCanvasView(a,b){CanvasView.call(this,a,b,[{image:CanvasView.loadImage("spaceship"),width:40,height:20}]);var c={image:CanvasView.loadImage("doubleflame"),width:120,height:30,offsetX:-57,offsetY:0};EnginePoweredCanvasView.call(this,c)}SpaceShipCanvasView.prototype=Object.create(CanvasView.prototype);CanvasRenderer.registerViewClass("spaceship",SpaceShipCanvasView);function StarCanvasView(a,b){CanvasView.call(this,a,b,[CanvasView.sphere("star",a,2.2)])}StarCanvasView.prototype=Object.create(CanvasView.prototype);CanvasRenderer.registerViewClass("star",StarCanvasView);CanvasRenderer.registerViewClass("fixedstar",StarCanvasView);function TouchControlView(){View.call(this,null,"touchcontrol",document.body)}TouchControlView.prototype=Object.create(View.prototype);TouchControlView.prototype.constructor=TouchControlView;function DebugView(a,b,c){this.projection={timerLag:function(){var b=Math.round(100*a.avgStepsPerCB)/100;return{textContent:b,className:1.1>b?"normal":"warning"}},fuel:function(){return a.spaceObjects[0].enginePowered.fuel}};View.call(this,a,"Debug",c);SimulationObserver.call(this,a)}DebugView.prototype=Object.create(View.prototype);DebugView.prototype.constructor=DebugView;DebugView.prototype.oneStepTaken=function(){this.updateAll()};function Controller(a,b,c){this.model=a;this.view||(this.view=new View(this.model,this.templateId,b,c));this.controlElements=this.view&&this.view.loadElementsToObject("[data-control]","data-control");this.setupDataBinding();this.bindEvents()}Controller.prototype.eventMapping={};Controller.controllerClasses={};Controller.registerClass=function(a,b){"undefined"===typeof b&&(b=a.name);a.prototype.templateId=b;Controller.controllerClasses[b]=a};
Controller.createForTemplate=function(a,b,c){var d=Controller.controllerClasses[a];return"function"!==typeof d?(d=new Controller,d.view=null,d.templateId=a,Controller.call(d,b,c),d):new d(b,c)};
Controller.prototype.bindEvents=function(){function a(a,d,e){try{e.addEventListener(a,function(a){a.preventDefault();d.call(b,a)})}catch(g){console.error("Cannot bind event "+a+" to control "+c,g)}}var b=this,c;for(c in this.eventMapping){var d=this.controlElements[c],e=this.eventMapping[c],g;for(g in e)a(g,e[g],d)}};
Controller.prototype.setupDataBinding=function(){this.view&&this.view.rootElement&&(this.clearDataBinding(),this.dataElements=this.view.loadElementsToObject("input[data-field],select[data-field]","data-field"),Object.keys(this.dataElements).length&&(this.installedChangeHandler=this.changeHandler.bind(this),this.view.rootElement.addEventListener("change",this.installedChangeHandler)))};
Controller.prototype.clearDataBinding=function(){this.installedChangeHandler&&(this.view.rootElement.removeEventListener("change",this.installedChangeHandler),this.installedChangeHandler=null)};Controller.prototype.changeHandler=function(a){var b=a.target.getAttribute("data-field"),c=a.target.value;"checkbox"==a.target.type&&(c=a.target.checked);a=this.view.projection[b];"undefined"===typeof a?this.model[b]=c:"function"==typeof a&&a.call(this.view,c)};function EditedSceneEntry(a,b){this.eventMapping={edit:{click:this.edit.bind(this)}};Controller.call(this,a,b)}EditedSceneEntry.prototype=Object.create(Controller.prototype);EditedSceneEntry.prototype.constructor=EditedSceneEntry;Controller.registerClass(EditedSceneEntry);EditedSceneEntry.prototype.edit=function(a){new Editor(document.body,this.model.localLevelIndex)};function KeyboardController(a,b){this.spaceShip=a;this.camera=b;this.installedKeydownHandler=this.keydownHandler.bind(this);this.installedKeyupHandler=this.keyupHandler.bind(this);document.addEventListener("keydown",this.installedKeydownHandler);document.addEventListener("keyup",this.installedKeyupHandler);a.simulation.addEventListener("stop",this.releaseResources.bind(this))}
KeyboardController.prototype.keydownHandler=function(a){switch(a.key){case "ArrowRight":this.spaceShip.startRotationRight();break;case "ArrowLeft":this.spaceShip.startRotationLeft();break;case "ArrowUp":this.spaceShip.startEngine();break;case " ":case "Spacebar":this.spaceShip.launchMissile();break;case "Control":this.camera.switchOutlined()}};KeyboardController.prototype.keyupHandler=function(a){switch(a.key){case "ArrowRight":case "ArrowLeft":this.spaceShip.stopRotation();break;case "ArrowUp":this.spaceShip.stopEngine()}};
KeyboardController.prototype.releaseResources=function(){document.removeEventListener("keydown",this.installedKeydownHandler);document.removeEventListener("keyup",this.installedKeyupHandler)};function TouchController(a,b,c){this.eventMapping={leftcontrol:{touchstart:a.startRotationLeft.bind(a),touchend:a.stopRotation.bind(a),touchcancel:a.stopRotation.bind(a)},rightcontrol:{touchstart:a.startRotationRight.bind(a),touchend:a.stopRotation.bind(a),touchcancel:a.stopRotation.bind(a)},enginecontrol:{touchstart:a.startEngine.bind(a),touchend:a.stopEngine.bind(a),touchcancel:a.stopEngine.bind(a)},firecontrol:{touchstart:a.launchMissile.bind(a)},outlinecontrol:{touchstart:b.switchOutlined?b.switchOutlined.bind(b):
function(){}}};this.view=c;Controller.call(this,a)}TouchController.prototype=Object.create(Controller.prototype);TouchController.prototype.constructor=TouchController;TouchController.createControllerFor=function(a,b){if(!BrowserFeatures.hasTouch)return null;var c=new TouchControlView;return new TouchController(a,b,c)};function SceneSelector(a){this.model={editedScenes:LocalScenes.getList().map(function(a,c){return{name:"Edited Level "+(c+1),localLevelIndex:c}})};this.view=new View(this.model,this.templateId,a);this.eventMapping={loadScene:{click:this.loadScene.bind(this)},loadEditedScene:{click:this.loadEditedScene.bind(this)}};Controller.call(this,this.model,this.view);CustomEventTarget.call(this)}SceneSelector.prototype=Object.create(Controller.prototype);SceneSelector.prototype.constructor=SceneSelector;Controller.registerClass(SceneSelector);
SceneSelector.prototype.loadScene=function(a){this.emit("sceneselected",a.target.dataset.scene)};SceneSelector.prototype.loadEditedScene=function(a){a=this.view.getModelForElement(a.target);this.emit("editedsceneselected",a.localLevelIndex)};function MainController(a){this.model={};Controller.call(this,this.model,a);this.selectScene("SpaceDebrisScene");this.showSceneSelector()}MainController.prototype=Object.create(Controller.prototype);MainController.prototype.constructor=MainController;Controller.registerClass(MainController,"Main");
MainController.prototype.selectScene=function(a){this.hideSceneSelector();this.removeSimulation();var b=a;"object"===typeof a&&(b=a.detail);this.simulation=new Simulation(60);this.renderer=new CanvasRenderer(this.simulation,document.body);this.scene=Scene.createScene(b,this.simulation,this.renderer);this.debugView=new DebugView(this.simulation,this.renderer,this.view);this.simulation.start();this.renderer.start();this.bindToObjective(this.scene.objective)};
MainController.prototype.editedSceneSelectedHandler=function(a){var b;try{this.hideSceneSelector(),this.removeSimulation(),b=LocalScenes.get(a.detail),"string"===typeof b&&(b=JSON.parse(b)),this.simulation=new Simulation(60),this.renderer=new CanvasRenderer(this.simulation,document.body),this.scene=new PlayScene(this.simulation,this.renderer,b),this.simulation.start(),this.renderer.start()}catch(c){console.error("Unable to start scene "+b),this.showSceneSelector()}};
MainController.prototype.bindToObjective=function(a){a&&(this.unbindObjective(),this.objective=a,this.winHandler=function(){alert("win!");this.showSceneSelector()}.bind(this),this.failhandler=function(a){var c,d=this;try{c=a.detail.lostObject.constructor.name}catch(e){}setTimeout(function(){alert("fail: "+c);d.showSceneSelector()},1E3)}.bind(this),a.addEventListener("win",this.winHandler),a.addEventListener("fail",this.failhandler))};
MainController.prototype.unbindObjective=function(){this.objective&&(this.winHandler&&this.objective.removeEventListener("win",this.winHandler),this.failHandler&&this.objective.removeEventListener("fail",this.failHandler),this.objective=null)};
MainController.prototype.removeSimulation=function(){this.simulation&&(this.simulation.stop(),this.simulation=null,this.renderer.stop(),this.renderer=null,this.debugView&&(this.debugView.rootElement.parentNode.removeChild(this.debugView.rootElement),this.debugView=null),this.scene=null)};
MainController.prototype.showSceneSelector=function(){this.sceneSelector?this.view.rootElement.appendChild(this.sceneSelector.view.rootElement):(this.sceneSelector=new SceneSelector(this.view),this.sceneSelector.addEventListener("sceneselected",this.selectScene.bind(this)),this.sceneSelector.addEventListener("editedsceneselected",this.editedSceneSelectedHandler.bind(this)))};MainController.prototype.hideSceneSelector=function(){this.sceneSelector&&this.view.rootElement.removeChild(this.sceneSelector.view.rootElement)};function DragController(a){this.editor=a;this.model={};Controller.call(this,this.model);a.view.rootElement.addEventListener("pointerdown",this.downHandler.bind(this),!0);a.view.rootElement.addEventListener("pointermove",this.moveHandler.bind(this),!0);a.view.rootElement.addEventListener("pointerup",this.upHandler.bind(this),!0);this.lastDragX=null}DragController.prototype=Object.create(Controller.prototype);DragController.prototype.constructor=DragController;
Controller.registerClass(DragController,null);DragController.prototype.downHandler=function(a){if(this.editor.isPointerEventOnScene(a)){var b=this.editor.renderer.clickedObject(a.clientX,a.clientY);b&&b===this.editor.selectedObject&&(a.stopPropagation(),this.lastDragX=a.clientX,this.lastDragY=a.clientY)}};
DragController.prototype.moveHandler=function(a){null!==this.lastDragX&&(a.stopPropagation(),this.editor.selectedObject.pos.add((new Vector(a.clientX-this.lastDragX,a.clientY-this.lastDragY)).multiply(1/this.editor.renderer.viewPort.viewScale)),this.lastDragX=a.clientX,this.lastDragY=a.clientY,this.editor.render())};DragController.prototype.upHandler=function(a){this.lastDragX&&(this.lastDragX=null,a.stopPropagation())};function Editor(a,b){this.localLevelIndex=b;this.model={};Controller.call(this,this.model,a);CustomEventTarget.call(this);this.isPlaying=!1;this.savedState=null;this.initSimulation();this.edit();this.initControls()}Editor.prototype=Object.create(Controller.prototype);Editor.prototype.constructor=Editor;Controller.registerClass(Editor);
Editor.prototype.initControls=function(){this.toolbar=new Toolbar(this,this.view);this.propertyEditor=new PropertyEditor(this,this.view);this.selector=new SelectorController(this,this.view);this.dragger=new DragController(this);this.playControls=new PlayControls(this,this.view)};
Editor.prototype.initSimulation=function(){this.simulation=new Simulation;this.renderer=new EditorRenderer(this,this.view.rootElement);this.scene=new EditorScene(this);this.simulation.setUpModel();this.renderer.start();this.imageLoadEventListener=this.render.bind(this);CanvasView.addEventListener("load",this.imageLoadEventListener);this.render()};
Editor.prototype.freeSimulation=function(){this.simulation&&(this.simulation.stop(),this.simulation=null);this.renderer&&(this.renderer.stop(),this.renderer=null);this.scene=null;CanvasView.removeEventListener("load",this.imageLoadEventListener);this.imageLoadEventListener=null};Editor.prototype.freePlaySimulation=function(){this.playSimulation&&(this.playSimulation.stop(),this.playSimulation=null);this.playRenderer&&(this.playRenderer.stop(),this.playRenderer=null);this.playScene=null};
Editor.prototype.selectSpaceObject=function(a){this.selectedObject=a;this.emit("selected",a);this.render()};Editor.prototype.addSpaceObject=function(a){this.simulation.addSpaceObject(a);this.selectSpaceObject(a)};Editor.prototype.render=function(){this.renderer.redrawNeeded=!0;this.emit("render")};
Editor.prototype.play=function(){this.isPlaying=!0;this.view.rootElement.classList.add("playing");this.savedState=this.simulation.getState();this.save();this.playSimulation=new Simulation(60);this.playRenderer=new CanvasRenderer(this.playSimulation,this.view.rootElement);this.playScene=new PlayScene(this.playSimulation,this.playRenderer,this.savedState);this.playSimulation.start();this.playRenderer.start()};
Editor.prototype.edit=function(){this.isPlaying=!1;this.freePlaySimulation();this.view.rootElement.classList.remove("playing");this.render()};Editor.prototype.isPointerEventOnScene=function(a){return this.renderer&&a.target===this.renderer.canvas};Editor.prototype.save=function(){var a=JSON.stringify(this.savedState);"undefined"===typeof this.localLevelIndex?this.localLevelIndex=LocalScenes.add(a):LocalScenes.set(this.localLevelIndex,a)};function PlayControls(a,b){this.editor=a;this.model={};this.eventMapping={edit:{click:this.editor.edit.bind(this.editor)}};Controller.call(this,this.model,b)}PlayControls.prototype=Object.create(Controller.prototype);PlayControls.prototype.constructor=PlayControls;Controller.registerClass(PlayControls);function PropertyEditor(a,b){this.editor=a;this.loadSpaceObject({});this.view=new PropertyEditorView(this.spaceObject,b);this.view.addEventListener("typechange",this.typeChangeHandler.bind(this));this.editor.addEventListener("selected",this.selectHandler.bind(this));this.editor.addEventListener("render",this.view.updateAll.bind(this.view));this.eventMapping={delete:{click:this.deleteSpaceObject.bind(this)}};Controller.call(this,this.model,this.view)}PropertyEditor.prototype=Object.create(Controller.prototype);
PropertyEditor.prototype.constructor=PropertyEditor;PropertyEditor.prototype.selectHandler=function(a){this.loadSpaceObject(a.detail)};PropertyEditor.prototype.loadSpaceObject=function(a){this.spaceObject=a;this.view&&this.view.setModel(this.spaceObject)};PropertyEditor.prototype.changeHandler=function(a){Controller.prototype.changeHandler.call(this,a);this.editor.render()};
PropertyEditor.prototype.typeChangeHandler=function(a){var b=window[a.detail];if("function"!==typeof b)console.error("Unknown type: "+a.detail);else{a=this.spaceObject;var c=a.simulation,b=new b;this.copySpaceObject(a,b);c.removeSpaceObject(a);c.addSpaceObject(b);c.purgeSpaceObjects();this.editor.selectSpaceObject(b)}};PropertyEditor.prototype.copySpaceObject=function(a,b){var c=["pos","v"],d;for(d in a)-1!==c.indexOf(d)&&(b[d]=a[d])};
PropertyEditor.prototype.deleteSpaceObject=function(){this.editor.simulation.removeSpaceObject(this.spaceObject);this.editor.simulation.purgeSpaceObjects();this.editor.selectSpaceObject(this.editor.simulation.spaceObjects[0])};function SelectorController(a,b){this.editor=a;this.model={};Controller.call(this,this.model,b);a.view.rootElement.addEventListener("pointerup",this.upHandler.bind(this));a.view.rootElement.addEventListener("pointerdown",this.downHandler.bind(this))}SelectorController.prototype=Object.create(Controller.prototype);SelectorController.prototype.constructor=SelectorController;Controller.registerClass(SelectorController,"Selector");
SelectorController.prototype.downHandler=function(a){this.down=new Vector(a.clientX,a.clientY)};SelectorController.prototype.upHandler=function(a){!this.editor.isPointerEventOnScene(a)||5<this.down.distanceFrom(new Vector(a.clientX,a.clientY))||(a=this.editor.renderer.clickedObject(a.clientX,a.clientY)||{},this.editor.selectSpaceObject(a))};function Toolbar(a,b){this.editor=a;this.model={};this.eventMapping={createobject:{click:this.createObject.bind(this)},play:{click:this.editor.play.bind(this.editor)}};Controller.call(this,this.model,b,{forecastSteps:function(b){"undefined"!==typeof b&&(a.renderer.forecastSteps=Number(b),a.render());return{value:a.renderer.forecastSteps}}})}Toolbar.prototype=Object.create(Controller.prototype);Toolbar.prototype.constructor=Toolbar;Controller.registerClass(Toolbar);
Toolbar.prototype.createObject=function(){var a=new Planet(new Vector(100,100),Vector.zero.clone());this.editor.addSpaceObject(a)};function EditorScene(a){Scene.call(this,a.simulation,a.renderer);this.editor=a}EditorScene.prototype=Object.create(Scene.prototype);EditorScene.prototype.constructor=EditorScene;Scene.registerScene(EditorScene);
EditorScene.prototype.setUpModel=function(){var a=this.simulation,b=LocalScenes.get(this.editor.localLevelIndex);if(this.editor.savedState)a.setState(this.editor.savedState),this.editor.savedState=null;else if(b&&""!==b)try{a.setState(JSON.parse(b))}catch(c){console.error("Cannot restore from state: "+b)}a.spaceObjects.length||a.addSpaceObject(new SpaceShip(a,new Vector(0,0),new Vector(0,0),.1,0));a=new EditorCamera(this.editor,this.simulation,this.renderer.viewPort);this.renderer.setCamera(a)};function PlayScene(a,b,c){Scene.call(this,a,b);this.descriptor=c}PlayScene.prototype=Object.create(Scene.prototype);PlayScene.prototype.constructor=PlayScene;Scene.registerScene(PlayScene);
PlayScene.prototype.setUpModel=function(){this.simulation.setState(this.descriptor);var a=this.simulation.spaceObjects.find(function(a){return a instanceof SpaceShip}),b=new OutlineCamera(new SimpleCamera(this.simulation,this.renderer.viewPort,a),-1500,-1500,3E3,3E3);this.renderer.setCamera(b);new KeyboardController(a,b);(a=TouchController.createControllerFor(a,b))&&this.renderer.viewElement.appendChild(a.view.rootElement)};function EditorCamera(a,b,c){Camera.call(this,b,c);this.editor=a;this.center=Vector.zero.clone();this.zoom=1;SimulationObserver.call(this,b);this.activeTouches={};this.activeTouchNum=0;this.rootElement=this.editor.view.rootElement;this.installedWheelHandler=this.wheelHandler.bind(this);this.installedMoveHandler=this.moveHandler.bind(this);this.installedDownHandler=this.downHandler.bind(this);this.installedUpHandler=this.upHandler.bind(this);this.rootElement.addEventListener("wheel",this.installedWheelHandler);
this.rootElement.addEventListener("pointermove",this.installedMoveHandler);this.rootElement.addEventListener("pointerdown",this.installedDownHandler);this.rootElement.addEventListener("pointerup",this.installedUpHandler);this.rootElement.addEventListener("pointercancel",this.installedUpHandler)}EditorCamera.prototype=Object.create(Camera.prototype);EditorCamera.prototype.constructor=EditorCamera;
EditorCamera.prototype.updateView=function(){this.zoom=Math.max(Math.min(this.zoom,5),.05);this.viewPort.setModelViewPortWithCenterZoom(this.center,this.zoom)};EditorCamera.prototype.wheelHandler=function(a){"INPUT"!==a.target.tagName&&(a=a.deltaY,0<a?this.zoom*=1.04:0>a&&(this.zoom/=1.04),this.editor.render())};
EditorCamera.prototype.downHandler=function(a){this.editor.isPointerEventOnScene(a)&&(this.activeTouches[a.pointerId]=a,this.activeTouchNum+=1,2===this.activeTouchNum&&(this.originalTouchInfo=this.getMultitouchInfo(),this.originalZoom=this.zoom,this.originalCenter=this.center.clone(),this.originalTouchCenter=this.viewPort.projectToModel(this.originalTouchInfo.center),this.originalTouchCenterShift=this.center.clone().add(this.originalTouchCenter.clone().multiply(-1))))};
EditorCamera.prototype.upHandler=function(){this.activeTouches={};this.activeTouchNum=0};
EditorCamera.prototype.moveHandler=function(a){var b=this.activeTouches[a.pointerId];b&&(1===this.activeTouchNum?this.center.add((new Vector(b.clientX-a.clientX,b.clientY-a.clientY)).multiply(1/this.viewPort.viewScale)):2===this.activeTouchNum&&(b=this.getMultitouchInfo(),this.zoom=b.distance/this.originalTouchInfo.distance*this.originalZoom,this.center=this.originalTouchCenter.clone().add(this.originalTouchCenterShift.clone().multiply(this.originalZoom/this.zoom))),this.activeTouches[a.pointerId]=
a,this.editor.render())};EditorCamera.prototype.getMultitouchInfo=function(){var a=Vector.zero.clone(),b=0,c=null,d;for(d in this.activeTouches){var e=new Vector(this.activeTouches[d].clientX,this.activeTouches[d].clientY);a.add(e);c&&(b+=c.distanceFrom(e));c=e}a.multiply(1/this.activeTouchNum);return{center:a,distance:b}};
EditorCamera.prototype.simulationStopped=function(){this.rootElement.removeEventListener("wheel",this.installedWheelHandler);this.rootElement.removeEventListener("pointermove",this.installedMoveHandler);this.rootElement.removeEventListener("pointerdown",this.installedDownHandler);this.rootElement.removeEventListener("pointerup",this.installedUpHandler);this.rootElement.removeEventListener("pointercancel",this.installedUpHandler)};function EditorRenderer(a,b){CanvasRenderer.call(this,a.simulation,b,"EditorArea");this.editor=a;this.forecastSteps=1200;this.forecaster=new Forecaster(a.simulation,this.forecastSteps)}EditorRenderer.prototype=Object.create(CanvasRenderer.prototype);EditorRenderer.prototype.constructor=EditorRenderer;EditorRenderer.prototype.redraw=function(){CanvasRenderer.prototype.redraw.call(this);this.renderForecast()};
EditorRenderer.prototype.stop=function(){CanvasRenderer.prototype.stop.call(this);this.forecaster=null};CanvasView.loadImage("selected");EditorRenderer.prototype.updateView=function(a){CanvasRenderer.prototype.updateView.call(this,a);try{a.model===this.editor.selectedObject&&a.drawPart({image:CanvasView.loadImage("selected"),width:2.2*a.model.radius,height:2.2*a.model.radius})}catch(b){console.error(b)}};
EditorRenderer.prototype.createColors=function(){var a={Planet:"blue",Star:"orange",SpaceShip:"yellow",Moon:"gray"},b={};this.simulation.spaceObjects.forEach(function(c){b[c.id]=a[c.constructor.name]||"white"});return b};
EditorRenderer.prototype.renderForecast=function(){this.forecaster.steps=this.forecastSteps;var a=this.forecaster.createForecast(),b=this.createColors(),c;for(c in a){this.ctx.strokeStyle=b[c];this.ctx.beginPath();for(var d=a[c],e=0;e<d.length;++e){var g=this.viewPort.projectToView(d[e]);this.ctx.lineTo(g.x,g.y)}this.ctx.stroke()}};
EditorRenderer.prototype.nearestObject=function(a,b){for(var c=this.viewPort.projectToModel(new Vector(a,b)),d=Infinity,e=null,g=0;g<this.views.length;++g){var m=this.views[g].model,t=m.pos.distanceFrom(c)-m.radius;t<d&&(d=t,e=m)}return e};EditorRenderer.prototype.clickedObject=function(a,b){var c=this.nearestObject(a,b),d=this.viewPort.projectToModel(new Vector(a,b));return!c||c.pos.distanceFrom(d)>10+c.radius?null:c};function PropertyEditorView(a,b){var c=function(a,b){return b?function(c){"undefined"!==typeof c&&(this.model[a][b]=Number(c));return{value:this.model[a]?this.model[a][b]:0}}:function(b){"undefined"!==typeof b&&(this.model[a]=Number(b));return{value:this.model[a]}}};this.projection={root:function(){return{class:{visible:this.model&&this.model instanceof SpaceObject}}},type:function(a){return a?(this.emit("typechange",a),a):{value:this.model.constructor.name}},x:c("pos","x"),y:c("pos","y"),vx:c("v",
"x"),vy:c("v","y"),mass:c("mass"),radius:c("radius"),indestructible:function(a){"undefined"!==typeof a&&(this.model.isIndestructible=a);return{checked:this.model.isIndestructible}}};View.call(this,a,"PropertyEditor",b);CustomEventTarget.call(this)}PropertyEditorView.prototype=Object.create(View.prototype);PropertyEditorView.prototype.constructor=PropertyEditorView;
PropertyEditorView.prototype.updateAll=function(){this.model&&this.model instanceof SpaceObject?View.prototype.updateAll.call(this):View.prototype.updateField.call(this,"root")};
